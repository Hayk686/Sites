<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8">
    <title>DuoTalk Web</title>
    <meta name="description" content="DuoTalk - современный многоязычный чат-мессенджер с шифрованием, переводами и голосовыми сообщениями">
    <link type="image/x-icon" href="/favicon.ico" rel="shortcut icon">
    <link type="image/x-icon" href="/favicon.ico" rel="icon">
    <meta name="keywords" content="чат, мессенджер, перевод, многоязычный, шифрование">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#6a5cff">
  <meta name="robots" content="index, follow">
  
  <!-- PWA Manifest -->
  <link rel="manifest" id="pwa-manifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="DuoTalk">
  
  <script>
    // Динамическое создание манифеста PWA
    const manifest = {
      name: "DuoTalk - Многоязычный чат",
      short_name: "DuoTalk",
      description: "Современный многоязычный чат-мессенджер с шифрованием",
      start_url: "/",
      display: "standalone",
      background_color: "#ffffff",
      theme_color: "#6a5cff",
      icons: [
        {
          src: "data:image/svg+xml;base64," + btoa(`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192" fill="#6a5cff">
              <circle cx="96" cy="96" r="88"/>
              <path d="M64 64h64v16H64zm0 24h64v16H64zm0 24h48v16H64z" fill="white"/>
            </svg>
          `),
          sizes: "192x192",
          type: "image/svg+xml"
        }
      ]
    };
    
    const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
    const manifestURL = URL.createObjectURL(manifestBlob);
    document.getElementById('pwa-manifest').href = manifestURL;
  </script>

  <!-- Предзагрузка шрифта для оптимизации -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* CSS Variables - оптимизированные значения */
:root {
      --primary: #6a5cff;
      --primary-dark: #4f8cff;
      --bg-light: #e0e0e0;
      --bg-dark: #404040;
      --text-light: #eeeeee;
      --text-dark: #333333;
      --border-light: #cccccc;
      --border-dark: #555555;
      --shadow: 0 2px 12px rgba(60,60,120,0.1);
      --transition: all 0.2s ease;
      --radius: 12px;
      --radius-lg: 0px;
    }
    
    /* Базовые стили - оптимизированные */
    *,*::before,*::after{box-sizing:border-box}
    body{
      margin:0;font-family:'Inter',sans-serif;background:#fff;color:var(--text-dark);
      min-height:100vh;display:flex;align-items:center;justify-content:center;
      transition:var(--transition);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    /* Layout - оптимизированный */
    .main-wrapper{
      display:flex;width:100vw;height:100vh;max-width:1400px;background:#fff;
      border-radius:var(--radius-lg);box-shadow:var(--shadow);overflow:hidden;
      will-change:transform;transform:translateZ(0);
    }

    /* Темная тема */
    body.theme-dark{background:var(--bg-dark);color:var(--text-light)}
    body.theme-dark .main-wrapper{background:var(--bg-dark)}
    body.theme-dark .sidebar{background:#181824;border-right-color:var(--border-dark)}
    body.theme-dark .chat-main{background:var(--bg-dark)}
    body.theme-dark .top-nav{background:var(--bg-dark);border-bottom-color:var(--border-dark)}
    body.theme-dark .inputs{background:var(--bg-dark);border-top-color:var(--border-dark)}
    

    /* Sidebar - оптимизированный */
    .sidebar{width:240px;background:var(--bg-light);border-right:1px solid var(--border-light);
      display:flex;flex-direction:column;transition:width 0.2s;contain:layout}
    .sidebar-header{font-size:1.5rem;padding:2vw;font-weight:700;color:var(--text-dark)}
    .chat-list{flex:1;overflow-y:auto;padding:0 0 10px 0;transform:translateZ(0)}
    .chat-list-item{display:flex;align-items:center;padding:14px 24px;cursor:pointer;
      border-radius:var(--radius);margin:0 8px 4px 8px;transition:var(--transition)}
    .chat-list-item:hover,.chat-list-item.selected{background:#fff}
    .avatar{width:38px;height:38px;border-radius:50%;margin-right:10px;background:#fff;
      display:flex;align-items:center;justify-content:center;font-weight:600;color:var(--primary)}
    .chat-list-info{flex:1;min-width:0}
    .chat-list-name{font-weight:600;color:var(--text-dark);font-size:16px;margin-bottom:2px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chat-list-preview{color:#7a7e8c;font-size:14px;display:flex;justify-content:space-between;
      align-items:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chat-list-preview span{color:#b3b8c5;font-size:12px;margin-left:8px}
    /* Chat Main - оптимизированный */
    .chat-main {
      flex: 1 1 0%;
      min-width: 0;
      display: flex;
      flex-direction: column;
      background: var(--bg-light);
      position: relative;
      contain: layout style;
    }
    .top-nav {
      display: flex;
      align-items: center;
      padding: 0 2vw;
      height: 60px;
      background: #fff;
      border-bottom: 1.5px solid var(--border-light);
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-dark);
      letter-spacing: 0.2px;
    }
    .nav-tab {
      margin-right: 2vw;
      cursor: pointer;
      padding: 10px 0;
      border-bottom: 2.5px solid transparent;
      transition: border 0.18s, color 0.18s;
      font-size: 1.05rem;
    }
    .nav-tab.active {
      color: #6a5cff;
      border-bottom: 2.5px solid #6a5cff;
    }
    .nav-menu {
      margin-left: auto;
      font-size: 28px;
      cursor: pointer;
      color: #b3b8c5;
    }
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: inherit; /* Было #181824 */
      border-radius: 0;
      box-shadow: none;
      color: #23243a; /* Меняем на темный цвет текста для светлой темы */
      padding: 0;
      position: relative;
      overflow: hidden;
    }
    /* Для темной темы восстанавливаем темный фон и светлый текст */
    body.theme-dark .chat-container {
      background: var(--bg-dark);
      color: var(--text-light);
    }
    .chat-header {
      background: none;
      color: var(--text-dark);
      padding: 1.5vw 0 1vw 0;
      text-align: left;
      font-size: 1.3rem;
      position: relative;
      letter-spacing: 0.5px;
      font-weight: 700;
      box-shadow: none;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      border-bottom: 1.5px solid var(--border-light);
      margin: 0 2vw;
    }

    #roomSelector, #nameInput {
      display: none;
    }
    .chat-window {
      flex: 1 1 0%;
      min-width: 0;
             padding: 0vw 0vw 0 0vw;
      overflow-y: auto;
      background: #fff;
      display: flex;
      flex-direction: column;
      scrollbar-width: thin;
      scrollbar-color: #6a5cff #e3e6ee;
      font-size: 1.1rem;
    }
    .chat-window::-webkit-scrollbar {
      width: 8px;
      background: #e3e6ee;
      border-radius: 8px;
    }
    .chat-window::-webkit-scrollbar-thumb {
      background: #6a5cff33;
      border-radius: 8px;
    }
    .msg {
      margin: 12px 0;
      display: flex;
      align-items: flex-end;
      max-width: 75%;
      position: relative;
      opacity: 0;
      transform: translateY(20px);
      animation: messageSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      font-size: 16px;
    }
    
    .msg.has-info-panel {
      overflow: visible;
    }
    
    @keyframes messageSlideIn {
      to { 
      opacity: 1;
        transform: translateY(0); 
    }
    }
    
    .msg.you {
      align-self: flex-end;
      flex-direction: row-reverse;
      margin-left: auto;
    }
    
    .msg.other {
      align-self: flex-start;
      margin-right: auto;
    }
    
    .msg-content {
      display: flex;
      align-items: flex-end;
      position: relative;
    }
    
          .bubble {
        padding: 14px 18px;
                border-radius: 22px 22px 22px 6px;
        background: #fff;
        color: var(--text-dark);
      font-size: 15px;
      line-height: 1.5;
      position: relative;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08), 0 1px 4px rgba(0, 0, 0, 0.04);
      margin: 0 8px;
      min-width: 50px;
      max-width: 100%;
      word-break: break-word;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.2s ease;
    }
    
    .bubble:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 25px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.06);
    }
    
    .msg.you .bubble {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #ffffff;
        border-radius: 22px 22px 6px 22px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 3px 20px rgba(102, 126, 234, 0.25), 0 1px 4px rgba(102, 126, 234, 0.1);
    }
    
    .msg.you .bubble:hover {
      box-shadow: 0 5px 30px rgba(102, 126, 234, 0.35), 0 2px 8px rgba(102, 126, 234, 0.15);
    }
    
    /* Удаляем старые хвостики и добавляем новые тонкие */
    .bubble:after {
      content: '';
      position: absolute;
      bottom: 8px;
      left: -6px;
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-right: 8px solid var(--bg-light);
      border-bottom: 0 solid transparent;
      border-left: 0 solid transparent;
      filter: drop-shadow(-1px 1px 2px rgba(0, 0, 0, 0.1));
      display: none;
    }
    
    .msg.other .bubble:after {
      display: block;
    }
    
    .msg.you .bubble:after {
      left: auto;
      right: -6px;
      border-right: 0 solid transparent;
      border-left: 8px solid #667eea;
      filter: drop-shadow(1px 1px 2px rgba(102, 126, 234, 0.2));
      display: block;
    }
    
    .msg-time {
      font-size: 11px;
      color: var(--border-dark);
      margin: 0 4px;
      align-self: flex-end;
      position: absolute;
      bottom: -18px;
      right: 0;
      font-weight: 500;
      opacity: 0.8;
      transition: opacity 0.2s ease;
    }
    
    .msg:hover .msg-time {
      opacity: 1;
    }
    
    .msg.you .msg-time {
      right: auto;
      left: 0;
      color: var(--primary-dark);
    }
    
    .read {
      font-size: 11px;
      color: #66bb6a;
      margin-left: 4px;
      align-self: flex-end;
      position: absolute;
      bottom: -18px;
      right: -20px;
      font-weight: 600;
      opacity: 0.9;
    }
    
    .msg.you .read {
      color: #66bb6a;
      right: auto;
      left: -20px;
    }
    
    .reply {
      font-size: 13px;
      margin-bottom: 8px;
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.1);
      border-left: 3px solid var(--primary);
      opacity: 0.9;
      font-style: italic;
      color: var(--text-dark);
      position: relative;
      overflow: hidden;
    }
    
    .msg.you .reply {
      background: rgba(255, 255, 255, 0.2);
      border-left-color: #ffffff;
      color: var(--text-light);
    }
    
    .reply:before {
      content: '↳';
      margin-right: 6px;
      opacity: 0.7;
    }
    
    /* Стили для кнопок сообщений */
    .msg-del-btn, .msg-info-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      z-index: 10;
    }
    
    .msg-info-btn {
      background: rgba(59, 130, 246, 0.9);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      right: 24px;
    }
    
    .msg:hover .msg-del-btn,
    .msg:hover .msg-info-btn {
      opacity: 1;
      transform: scale(1);
    }
    
    .msg-del-btn:hover {
      background: rgba(220, 38, 38, 1);
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
    }
    
    .msg-info-btn:hover {
      background: rgba(37, 99, 235, 1);
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
    }
    
    .msg-del-btn svg,
    .msg-info-btn svg {
      width: 14px;
      height: 14px;
    }
    .date-sep {
      text-align: center;
      color: var(--border-dark);
      margin: 24px 0 16px 0;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.5px;
      padding: 8px 16px;
      text-transform: uppercase;
    }
    
    .date-sep:before {
      display: none;
    }
    
              .date-sep:after {
      display: none;
    }
    
    /* Стили для темной темы */
    body.theme-dark .bubble {
      background: #2a2d3a;
      color: #f3f4f6;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3), 0 1px 4px rgba(0, 0, 0, 0.2);
    }
    
    body.theme-dark .bubble:hover {
      box-shadow: 0 4px 25px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.25);
    }
    
    body.theme-dark .msg.you .bubble {
      background: linear-gradient(135deg, #5b21b6 0%, #7c3aed 100%);
      color: #ffffff;
      border: 1px solid rgba(139, 92, 246, 0.3);
      box-shadow: 0 3px 20px rgba(91, 33, 182, 0.4), 0 1px 4px rgba(91, 33, 182, 0.2);
    }
    
    body.theme-dark .msg.you .bubble:hover {
      box-shadow: 0 5px 30px rgba(91, 33, 182, 0.5), 0 2px 8px rgba(91, 33, 182, 0.25);
    }
    
    body.theme-dark .bubble:after {
      border-right-color: #2a2d3a;
    }
    
    body.theme-dark .msg.you .bubble:after {
      border-left-color: #5b21b6;
    }
    
    body.theme-dark .msg-time {
      color: #9ca3af;
    }
    body.theme-dark .msg.you .msg-time {
      color: #a78bfa;
    }
    
    body.theme-dark .reply {
      background: rgba(255, 255, 255, 0.05);
      border-left-color: var(--text-light);
      color: #d1d5db;
    }
    
    body.theme-dark .msg.you .reply {
      background: rgba(255, 255, 255, 0.2);
      border-left-color: #ffffff;
      color: var(--text-light);
    }
    
    body.theme-dark .date-sep {
      color: var(--border-dark);
    }
    
    body.theme-dark .date-sep:before {
      background: linear-gradient(to right, transparent 0%, var(--border-dark) 20%, var(--border-dark) 80%, transparent 100%);
    }
    
    body.theme-dark .date-sep:after {
      background: var(--bg-dark);
      border-color: var(--border-dark);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    /* Панель информации слева от сообщения */
    .msg-info-panel {
      position: absolute;
      left: -160px;
      top: 0;
      opacity: 0;
      transform: translateX(-20px);
      transition: all 0.2s ease;
      z-index: 100;
    }
    
    .msg-info-panel.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .msg-info-content {
      background: #ffffff;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      width: 140px;
      position: relative;
    }
    
    .msg-info-close {
      position: absolute;
      top: 6px;
      right: 6px;
      background: none;
      border: none;
      font-size: 14px;
      color: #9ca3af;
      cursor: pointer;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 3px;
      transition: all 0.2s ease;
      z-index: 1;
    }
    
    .msg-info-close:hover {
      background: #e5e7eb;
      color: #374151;
    }
    
    .msg-info-body {
      padding: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .msg-info-item {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 45px;
    }
    
    .msg-info-label {
      font-weight: 600;
      color: #9ca3af;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .msg-info-value {
      color: #374151;
      font-size: 12px;
      line-height: 1.3;
      word-break: break-word;
      flex: 1;
    }
    

    

    
    /* Стили для темной темы */
    body.theme-dark .msg-info-content {
      background: #1f2937;
      border-color: #374151;
    }
    
    body.theme-dark .msg-info-close {
      color: #6b7280;
    }
    
    body.theme-dark .msg-info-close:hover {
      background: #374151;
      color: #d1d5db;
    }
    
    body.theme-dark .msg-info-item {
      background: #111827;
      border-color: #374151;
    }
    
    body.theme-dark .msg-info-label {
      color: #6b7280;
    }
    
    body.theme-dark .msg-info-value {
      color: #e5e7eb;
    }
    .status {
      font-size:13px;
      color: var(--text-muted);
      height:20px;
      padding:0 12px;
      background: none;
      border: none;
      box-shadow: none;
    }
    .inputs {
      display: flex;
              gap: 1vw;
        padding: 1.5vw 2vw 1.5vw 2vw;
        border-top: 1.5px solid var(--border-light);
        background: #fff;
        box-shadow: none;
      align-items: center;
    }
    .inputs input[type=text] {
      flex: 1;
      border: 1.5px solid var(--border-light);
              border-radius: 22px;
        padding: 1vw 1.5vw;
        background: #fff;
        color: var(--text-dark);
      font-size: 1.1rem;
      outline: none;
      transition: border 0.2s, box-shadow 0.2s;
      box-shadow: none;
    }
    .inputs input[type=text]:focus {
      border: 1.5px solid #6a5cff;
      box-shadow: 0 2px 8px 0 rgba(90,90,200,0.10);
    }
    .inputs button {
      background: #fff;
      color: var(--text-dark);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, transform 0.1s, box-shadow 0.2s;
      box-shadow: 0 2px 8px 0 rgba(106,92,255,0.10);
      font-size: 1.2rem;
    }
    .inputs button:hover {
      background: #b0b0b0;
      transform: scale(1.08);
      box-shadow: 0 4px 16px 0 rgba(0,0,0,0.18);
    }
    .inputs button:active {
      transform: scale(0.96);
    }
    .inputs input[type=file] { display:none; }
    .mic-btn {
      background: var(--bg-dark);
      color: var(--primary);
      border: none;
      padding: 8px;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .mic-btn:hover {
      background: #2a2b41;
      transform: scale(1.05);
    }
    .mic-btn:active {
      transform: scale(0.95);
    }
    body.theme-dark .mic-btn {
      background: var(--bg-dark);
      color: var(--primary);
    }
    body.theme-dark .mic-btn:hover {
      background: #2a2b41;
    }

    /* Quick Translate Button Styles */
    #quickTranslateBtn {
      background: #fff;
      color: var(--text-dark);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    #quickTranslateBtn:hover {
      background: #b0b0b0; /* Темнее светло-серого */
      transform: scale(1.08);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
    }
    
    #quickTranslateBtn:active {
      transform: scale(0.96);
    }
    
    body.theme-dark #quickTranslateBtn {
      background: var(--border-dark);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    body.theme-dark #quickTranslateBtn:hover {
      background: #505050; /* Темнее темно-серого */
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }







    /* Message Translation Styles */
    .translate-btn {
      background: rgba(0, 0, 0, 0.1);
      color: #6a5cff;
      border: 1px solid rgba(106, 92, 255, 0.3);
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 12px;
      cursor: pointer;
      margin-left: 8px;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .translate-btn:hover {
      background: rgba(106, 92, 255, 0.2);
      border-color: rgba(106, 92, 255, 0.5);
    }

    body.theme-dark .translate-btn {
      background: rgba(106, 92, 255, 0.2);
      color: #8b7fff;
      border-color: rgba(106, 92, 255, 0.4);
    }

    body.theme-dark .translate-btn:hover {
      background: rgba(106, 92, 255, 0.3);
      border-color: rgba(106, 92, 255, 0.6);
    }

    .message-translation {
      background: rgba(106, 92, 255, 0.05);
      border-left: 3px solid #6a5cff;
      padding: 8px 12px;
      margin-top: 4px;
      border-radius: 0 6px 6px 0;
      position: relative;
      transition: all 0.2s ease;
    }

    .translation-text {
      color: #6a5cff;
      font-size: 13px;
      line-height: 1.4;
    }

    .translation-close {
      position: absolute;
      top: 4px;
      right: 8px;
      background: none;
      border: none;
      color: #6a5cff;
      font-size: 16px;
      cursor: pointer;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .translation-close:hover {
      background: rgba(106, 92, 255, 0.1);
    }

    body.theme-dark .message-translation {
      background: rgba(106, 92, 255, 0.1);
      border-left-color: #8b7fff;
    }

    body.theme-dark .translation-text {
      color: #8b7fff;
    }

    body.theme-dark .translation-close {
      color: #8b7fff;
    }

    body.theme-dark .translation-close:hover {
      background: rgba(106, 92, 255, 0.2);
    }

    /* Quick Translate Modal Styles */
    .quick-translate-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .quick-translate-modal.show {
      opacity: 1;
      visibility: visible;
    }
    
    .quick-translate-content {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }
    
    .quick-translate-modal.show .quick-translate-content {
      transform: translateY(0);
    }
    
    .quick-translate-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .quick-translate-title {
      font-size: 18px;
      font-weight: 600;
      color: #23243a;
    }
    
    .quick-translate-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .quick-translate-close:hover {
      background: #f3f4f6;
      color: #374151;
    }
    
    .translate-section {
      margin-bottom: 16px;
    }
    
    .translate-section label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }
    
    .translate-section textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      transition: border-color 0.2s ease;
      font-family: inherit;
    }
    
    .translate-section textarea:focus {
      outline: none;
      border-color: #6a5cff;
      box-shadow: 0 0 0 3px rgba(106, 92, 255, 0.1);
    }
    
    .translate-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    .translate-btn-action {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }
    
    .translate-btn-primary {
      background: linear-gradient(135deg, #6a5cff 0%, #4f8cff 100%);
      color: #fff;
    }
    
    .translate-btn-primary:hover {
      background: linear-gradient(135deg, #5a4cff 0%, #3f7cff 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(106, 92, 255, 0.25);
    }
    
    .translate-btn-secondary {
      background: #f8f9fa;
      color: #6b7280;
      border: 1px solid #e5e7eb;
    }
    
    .translate-btn-secondary:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }
    
    /* Dark theme support for quick translate modal */
    body.theme-dark .quick-translate-content {
      background: #1f2937;
    }
    body.theme-dark .quick-translate-title {
      color: #f9fafb;
    }
    
    body.theme-dark .quick-translate-close {
      color: #9ca3af;
    }
    
    body.theme-dark .quick-translate-close:hover {
      background: #374151;
      color: #f3f4f6;
    }
    
    body.theme-dark .translate-section label {
      color: #e5e7eb;
    }
    
    body.theme-dark .translate-section textarea {
      background: #374151;
      border-color: #4b5563;
      color: #f9fafb;
    }
    
    body.theme-dark .translate-section textarea:focus {
      border-color: #6a5cff;
      box-shadow: 0 0 0 3px rgba(106, 92, 255, 0.2);
    }
    
    body.theme-dark .translate-btn-secondary {
      background: #374151;
      color: #e5e7eb;
      border-color: #4b5563;
    }
    
    body.theme-dark .translate-btn-secondary:hover {
      background: #4b5563;
      border-color: #6b7280;
    }

    /* Language Selection Styles */
    .translate-language-section {
      display: flex;
      gap: 12px;
      align-items: end;
      margin-bottom: 20px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }

    .language-selector-group {
      flex: 1;
    }

    .language-selector-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .language-selector-group select {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      background: #fff;
      color: #374151;
      transition: border-color 0.2s ease;
    }

    .language-selector-group select:focus {
      outline: none;
      border-color: #6a5cff;
      box-shadow: 0 0 0 3px rgba(106, 92, 255, 0.1);
    }

    .language-swap {
      display: flex;
      align-items: end;
      padding-bottom: 8px;
    }

    #swapLanguagesBtn {
      background: #6a5cff;
      color: #fff;
      border: none;
      border-radius: 8px;
      width: 36px;
      height: 36px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #swapLanguagesBtn:hover {
      background: #5a4cff;
      transform: scale(1.05);
    }

    #swapLanguagesBtn:active {
      transform: scale(0.95);
    }

    .detected-language {
      margin-top: 8px;
      padding: 6px 12px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 6px;
      font-size: 13px;
      color: #059669;
    }

    #detectedLanguageName {
      font-weight: 600;
    }

    /* Dark theme support for language selection */
    body.theme-dark .translate-language-section {
      background: #374151;
      border-color: #4b5563;
    }

    body.theme-dark .language-selector-group label {
      color: #9ca3af;
    }

    body.theme-dark .language-selector-group select {
      background: #1f2937;
      border-color: #4b5563;
      color: #f9fafb;
    }

    body.theme-dark .language-selector-group select:focus {
      border-color: #6a5cff;
      box-shadow: 0 0 0 3px rgba(106, 92, 255, 0.2);
    }

    body.theme-dark .detected-language {
      background: rgba(16, 185, 129, 0.2);
      border-color: rgba(16, 185, 129, 0.4);
      color: #10b981;
    }

    .settings-panel {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #f6f7fa;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .settings-content {
      background: #fff;
      padding: 32px;
      border-radius: 22px;
      width: min(800px, 95vw);
      height: min(600px, 90vh);
      color: #23243a;
      box-shadow: 0 8px 32px rgba(31,38,135,0.15);
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 40px;
      position: relative;
      overflow: hidden;
    }
    
    .settings-sidebar {
      border-right: 1.5px solid #e3e6ee;
      padding-right: 32px;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .settings-main {
      flex: 1;
      max-width: 100%;
      overflow-y: auto;
      padding-right: 10px;
      padding-bottom: 80px;
    }
    
    .settings-main::-webkit-scrollbar {
      display: none;
    }
    
    .settings-main {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .settings-nav {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
    }

    .settings-nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #7a7e8c;
    }

    .settings-nav-item:hover {
      background: #f6f7fa;
      color: #23243a;
    }

    .settings-nav-item.active {
      background: #e8eafd;
      color: #6a5cff;
    }

    .settings-nav-item svg {
      width: 20px;
      height: 20px;
      stroke: currentColor;
    }
    .settings-content h2 {
      margin: 0 0 8px 0;
      font-size: 26px;
      font-weight: 700;
      color: #23243a;
      letter-spacing: -0.5px;
    }
    .settings-description {
      color: #7a7e8c;
      font-size: 15px;
      margin-bottom: 32px;
    }
    .settings-section {
      margin-bottom: 32px;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    .settings-section-title {
      font-size: 18px;
      font-weight: 600;
      color: #23243a;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .settings-section-title svg {
      width: 20px;
      height: 20px;
      stroke: #6a5cff;
    }
    .setting-item {
      margin-bottom: 24px;
    }
    .setting-item:last-child {
      margin-bottom: 0;
    }
    .setting-item label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #23243a;
      font-size: 15px;
    }
    .setting-item-description {
      color: #7a7e8c;
      font-size: 13px;
      margin-top: 4px;
    }
    .setting-item input[type="text"],
    .setting-item select {
      width: 100%;
      max-width: 100%;
      min-width: 100%;
      box-sizing: border-box;
      padding: 14px 18px;
      border: 1.5px solid #e3e6ee;
      border-radius: 14px;
      background: #fff;
      color: #23243a;
      font-size: 15px;
      outline: none;
      transition: all 0.2s ease;
      margin-bottom: 6px;
    }
    .setting-item input[type="text"]:hover,
    .setting-item select:hover {
      border-color: #d1d5db;
      background: #f8f9fb;
    }
    .setting-item input[type="text"]:focus,
    .setting-item select:focus {
      border-color: #6a5cff;
      box-shadow: 0 2px 8px rgba(106,92,255,0.12);
      background: #fff;
    }
    
    body.theme-dark .setting-item input[type="text"],
    body.theme-dark .setting-item select {
      background: #181824;
      border-color: #35354d;
      color: #f3f6fa;
    }
    
    body.theme-dark .setting-item input[type="text"]:hover,
    body.theme-dark .setting-item select:hover {
      background: #1f1f2f;
      border-color: #454565;
    }
    
    body.theme-dark .setting-item input[type="text"]:focus,
    body.theme-dark .setting-item select:focus {
      background: #181824;
      border-color: #6a5cff;
      box-shadow: 0 2px 8px rgba(106,92,255,0.2);
    }
    .setting-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #6a5cff;
      border-radius: 6px;
      margin-right: 8px;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    .checkbox-label span {
      font-size: 15px;
      color: #23243a;
    }
    .settings-actions {
      display: flex;
      gap: 12px;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1.5px solid #e3e6ee;
    }
    .settings-btn {
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .settings-btn.primary {
      background: linear-gradient(135deg, #6a5cff 0%, #4f8cff 100%);
      color: #fff;
      border: none;
      flex: 1;
    }
    .settings-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(106,92,255,0.18);
    }
    .settings-btn.secondary {
      background: #f6f7fa;
      color: #23243a;
      border: none;
    }
    .settings-btn.secondary:hover {
      background: #e3e6ee;
    }
    .settings-content button {
      background: linear-gradient(135deg, #6a5cff 0%, #4f8cff 100%);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
      margin-top: 8px;
    }
    .settings-content button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px 0 rgba(106,92,255,0.18);
    }
    @media (max-width: 1400px) {
      .settings-content {
        width: 90vw;
        max-width: 1000px;
      }
    }

    @media (max-width: 1100px) {
      .main-wrapper {
        max-width: 100vw;
        width: 100vw;
        height: 100vh;
        border-radius: 0;
      }
      .sidebar {
        width: 70px;
        min-width: 50px;
      }
      .chat-main {
        min-width: 0;
      }
      .chat-container {
        border-radius: 0;
      }
      .chat-window {
        padding: 12px 8px 0 8px;
      }
      .inputs {
        padding: 10px 8px 10px 8px;
      }
      .settings-content {
        width: 95vw;
        grid-template-columns: 200px 1fr;
        gap: 24px;
        padding: 24px;
      }
    }

    @media (max-width: 900px) {
      .settings-content {
        grid-template-columns: 180px 1fr;
        gap: 20px;
      }
      .settings-sidebar {
        padding-right: 20px;
      }
      .setting-item input[type="text"],
      .setting-item select {
        padding: 12px 16px;
      }
    }
    @media (max-width: 700px) {
      .main-wrapper {
        flex-direction: column;
        width: 100vw;
        height: 100vh;
        min-width: 0;
        min-height: 0;
      }
      .sidebar {
        width: 100vw;
        min-width: 0;
        max-width: 100vw;
        flex-direction: row;
        border-right: none;
        border-bottom: 1px solid #e3e6ee;
        height: 60px;
      }
      .sidebar-header {
        display: none;
      }
      .chat-main {
        flex: 1 1 0%;
        min-width: 0;
      }
      .settings-content {
        grid-template-columns: 1fr;
        gap: 0;
        padding: 16px;
        height: 100vh;
        border-radius: 0;
        max-width: 100vw;
        overflow-y: auto;
      }
      .settings-sidebar {
        border-right: none;
        border-bottom: 1.5px solid #e3e6ee;
        padding: 0 0 16px 0;
        margin-bottom: 16px;
      }
      .settings-nav {
        flex-direction: row;
        overflow-x: auto;
        padding-bottom: 8px;
        gap: 12px;
      }
      .settings-nav-item {
        white-space: nowrap;
      }
      .settings-logout-btn {
        margin: 16px 0 0 0;
        width: 100%;
      }
      .settings-save-btn {
        position: fixed;
        bottom: 16px;
        right: 16px;
        left: 16px;
        width: calc(100% - 32px);
      }
      body.theme-dark .settings-sidebar {
        border-bottom-color: #35354d;
      }
    }

    @media (max-width: 480px) {
      .settings-content {
        padding: 12px;
      }
      .setting-item {
        margin-bottom: 16px;
      }
      .setting-item input[type="text"],
      .setting-item select {
        padding: 10px 14px;
        font-size: 14px;
      }
      .settings-section-title {
        font-size: 16px;
      }
      .settings-nav-item {
        padding: 10px 14px;
        font-size: 14px;
      }
      .settings-save-btn {
        padding: 10px 20px;
        font-size: 14px;
        bottom: 12px;
        right: 12px;
        left: 12px;
      }
    }
      .chat-header, .chat-window, .inputs, .top-nav {
        padding-left: 2vw;
        padding-right: 2vw;
      }
      .chat-header {
        font-size: 1rem;
      }

      .inputs button {
        width: 32px;
        height: 32px;
        font-size: 1rem;
      }
    /* --- Theme Menu Styles --- */
    .theme-menu-backdrop {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.12);
      z-index: 1000;
      display: none;
      transition: background 0.25s;
    }
    .theme-menu {
      position: absolute;
      top: 56px;
      right: 32px;
      min-width: 220px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 32px 0 rgba(31,38,135,0.18);
      padding: 18px 0 10px 0;
      z-index: 1001;
      opacity: 0;
      transform: translateY(-16px) scale(0.98);
      pointer-events: none;
      transition: opacity 0.25s, transform 0.25s;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .theme-menu.open {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
    }
    .theme-menu-title {
      font-weight: 600;
      font-size: 17px;
      color: #23243a;
      padding: 0 24px 8px 24px;
      margin-bottom: 6px;
    }
    .theme-switcher {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 24px;
      cursor: pointer;
      border-radius: 10px;
      transition: background 0.18s;
    }
    .theme-switcher:hover {
      background: #e8eafd;
    }
    .theme-switcher input[type="radio"] {
      accent-color: #6a5cff;
      width: 18px; height: 18px;
    }
    .theme-switcher-label {
      font-size: 15px;
      color: #23243a;
      font-weight: 500;
    }
    .theme-menu-close {
      position: absolute;
      top: 10px; right: 14px;
      background: none;
      border: none;
      font-size: 20px;
      color: #888;
      cursor: pointer;
      transition: color 0.18s;
    }
    .theme-menu-close:hover { color: #6a5cff; }
    @media (max-width: 600px) {
      .theme-menu { right: 8px; min-width: 160px; }
    }
    body.theme-dark .main-wrapper {
      background: #23243a;
      color: #f3f6fa;
    }
    body.theme-dark .top-nav {
      background: #23243a;
      color: #f3f6fa;
      border-bottom: 1.5px solid #35354d;
    }

    body.theme-dark .sidebar {
      background: #181824;
      border-right: 1px solid #23243a;
    }

    body.theme-dark .sidebar-header {
      color: #f3f6fa;
    }

    body.theme-dark .chat-list-item {
      color: #f3f6fa;
    }

    body.theme-dark .chat-list-item.selected, 
    body.theme-dark .chat-list-item:hover {
      background: #23243a;
    }

    body.theme-dark .chat-list-name {
      color: #f3f6fa;
    }

    body.theme-dark .chat-list-preview {
      color: #b3b8c5;
    }
    body.theme-dark .settings-panel {
      background: #181824;
    }
    
    body.theme-dark .settings-content {
      background: #23243a;
      color: #f3f6fa;
      box-shadow: 0 8px 32px rgba(0,0,0,0.35);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.theme-dark .settings-content h2,
    body.theme-dark .settings-section-title {
      color: #f3f6fa;
    }
    
    body.theme-dark .settings-header {
      border-color: #35354d;
    }

    body.theme-dark .settings-description,
    body.theme-dark .setting-item-description {
      color: #9ba0af;
    }

    body.theme-dark .setting-item label {
      color: #f3f6fa;
    }

    body.theme-dark .setting-item input[type="text"],
    body.theme-dark .setting-item select {
      background: #181824;
      border-color: #35354d;
      color: #f3f6fa;
    }

    body.theme-dark .setting-item input[type="text"]:hover,
    body.theme-dark .setting-item select:hover {
      border-color: #454565;
    }

    body.theme-dark .setting-item input[type="text"]:focus,
    body.theme-dark .setting-item select:focus {
      border-color: #6a5cff;
      box-shadow: 0 2px 8px rgba(106,92,255,0.2);
    }

    body.theme-dark .checkbox-label span {
      color: #f3f6fa;
    }

    body.theme-dark .settings-actions {
      border-top-color: #35354d;
    }

    body.theme-dark .settings-btn.secondary {
      background: #181824;
      color: #f3f6fa;
    }

    body.theme-dark .settings-btn.secondary:hover {
      background: #35354d;
    }

    .settings-logout-btn {
      margin-top: auto;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
                                                                                                                                                                               padding: 12px 16px;
           border-radius: 12px;
           background: #8b0000 !important;
           color: #fff;
          border: none;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(139, 0, 0, 0.4);
          position: relative;
          overflow: hidden;
      font-size: 15px;
      font-weight: 600;
      width: 100%;
      transition: all 0.2s ease;
    }

                                                                               .settings-logout-btn:hover {
          background: #a00000 !important;
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(160, 0, 0, 0.5);
          letter-spacing: 0.5px;
    }

    .settings-logout-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 10px rgba(139, 0, 0, 0.6);
      transition: all 0.1s ease;
    }

    .settings-logout-btn svg {
      width: 20px;
      height: 20px;
      stroke: currentColor;
    }

    .settings-save-btn {
      margin-top: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 12px;
      background: #006400 !important;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      width: 100%;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 100, 0, 0.4);
      position: relative;
      overflow: hidden;
    }

    .settings-save-btn:hover {
      background: #008000 !important;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 128, 0, 0.5);
      letter-spacing: 0.5px;
    }

    .settings-save-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 10px rgba(0, 100, 0, 0.6);
      transition: all 0.1s ease;
    }

    .settings-save-btn svg {
      width: 20px;
      height: 20px;
      stroke: currentColor;
    }

    body.theme-dark .settings-nav-item {
      color: #9ba0af;
    }

    body.theme-dark .settings-nav-item:hover {
      background: #181824;
      color: #f3f6fa;
    }

    body.theme-dark .settings-nav-item.active {
      background: #35354d;
      color: #6a5cff;
    }

    body.theme-dark .settings-logout-btn {
      background: #8b0000 !important;
      color: #fff;
    }

    body.theme-dark .settings-logout-btn:hover {
      background: #a00000 !important;
    }

    body.theme-dark .settings-sidebar {
      border-right-color: #35354d;
    }
    body.theme-dark .bubble {
      background: #35354d;
      color: #fff;
    }
    body.theme-dark .msg.you .bubble {
      background: linear-gradient(135deg, #6a5cff 0%, #4f8cff 100%);
      color: #fff;
    }
    body.theme-dark .msg.other .bubble {
      background: #35354d;
      color: #f3f6fa;
    }
    body.theme-dark .inputs {
      background: #23243a;
      border-top: 1.5px solid #35354d;
    }
    body.theme-dark .inputs input[type=text] {
      border: 1.5px solid #35354d;
      background: #23243a;
      color: #f3f6fa;
    }
    body.theme-dark .inputs button {
      background: linear-gradient(135deg, #35354d 0%, #6a5cff 100%);
      color: #fff;
    }
    body.theme-dark .inputs button:hover {
      background: linear-gradient(135deg, #6a5cff 0%, #35354d 100%);
    }
    body.theme-dark .theme-menu {
      background: #23243a;
      color: #f3f6fa;
      box-shadow: 0 8px 32px 0 rgba(31,38,135,0.28);
    }
    body.theme-dark .theme-switcher:hover {
      background: #35354d;
    }
    body.theme-dark .theme-menu-title, body.theme-dark .theme-switcher-label {
      color: #f3f6fa;
    }
    body.theme-dark .theme-menu-close {
      color: #aaa;
    }
    body.theme-dark .theme-menu-close:hover {
      color: #6a5cff;
    }
    /* --- End Theme Menu Styles --- */
    
    /* --- Authentication Modal Styles --- */
    .auth-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .auth-modal-backdrop.show {
      opacity: 1;
      visibility: visible;
    }
    
    .auth-modal {
      background: #fff;
      border-radius: 20px;
      width: min(420px, 95vw);
      max-height: 90vh;
      overflow-y: auto;
      padding: 32px;
      position: relative;
      box-shadow: 0 24px 64px rgba(0, 0, 0, 0.25);
      transform: scale(0.9) translateY(-20px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .auth-modal-backdrop.show .auth-modal {
      transform: scale(1) translateY(0);
    }
    
    
    .auth-language-selector {
      margin-bottom: 24px;
      padding: 16px 32px;
      border-bottom: 1px solid #e3e6ee;
    }
    
    .auth-language-selector label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #23243a;
      font-size: 14px;
    }
    
    .auth-language-selector select {
      width: 100%;
      padding: 12px 16px;
      border: 1.5px solid #e3e6ee;
      border-radius: 12px;
      background: #fff;
      color: #23243a;
      font-size: 15px;
      outline: none;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .auth-language-selector select:focus {
      border-color: #6a5cff;
      box-shadow: 0 2px 8px rgba(106, 92, 255, 0.15);
    }
    
    .auth-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 32px;
      background: #f8f9fb;
      border-radius: 12px;
      padding: 4px;
    }
    .auth-tab {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      color: #7a7e8c;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .auth-tab.active {
      background: #fff;
      color: #6a5cff;
      box-shadow: 0 2px 8px rgba(106, 92, 255, 0.15);
    }
    
    .auth-form h2 {
      margin: 0 0 8px 0;
      font-size: 24px;
      font-weight: 700;
      color: #23243a;
      text-align: center;
    }
    
    .auth-description {
      color: #7a7e8c;
      font-size: 15px;
      text-align: center;
      margin-bottom: 24px;
    }
    
    .auth-field {
      margin-bottom: 20px;
    }
    
    .auth-field label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #23243a;
      font-size: 14px;
    }
    
    .auth-field input {
      width: 100%;
      padding: 14px 16px;
      border: 1.5px solid #e3e6ee;
      border-radius: 12px;
      background: #fff;
      color: #23243a;
      font-size: 15px;
      outline: none;
      transition: all 0.2s ease;
      box-sizing: border-box;
    }
    
    .auth-field input:focus {
      border-color: #6a5cff;
      box-shadow: 0 2px 8px rgba(106, 92, 255, 0.15);
    }
    
    .auth-field input:invalid {
      border-color: #ef4444;
    }
    
    .field-hint {
      display: block;
      margin-top: 4px;
      font-size: 12px;
      color: #7a7e8c;
    }
    
    .auth-btn {
      width: 100%;
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
      border: none;
    }
    
    .auth-btn.primary {
      background: linear-gradient(135deg, #6a5cff 0%, #4f8cff 100%);
      color: #fff;
    }
    
    .auth-btn.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(106, 92, 255, 0.25);
    }
    
    .auth-btn.secondary {
      background: #f8f9fb;
      color: #23243a;
      border: 1.5px solid #e3e6ee;
    }
    
    .auth-btn.secondary:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }
    
    .auth-links {
      text-align: center;
      margin-top: 16px;
    }
    
    .auth-links a {
      color: #6a5cff;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
    }
    
    .auth-links a:hover {
      text-decoration: underline;
    }
    
    .auth-agreement {
      margin-top: 16px;
    }
    
    .auth-agreement .checkbox-label {
      font-size: 13px;
      color: #7a7e8c;
    }
    
    .auth-divider {
      text-align: center;
      margin: 24px 0;
      position: relative;
    }
    
    .auth-divider::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: #e3e6ee;
    }
    
    .auth-divider span {
      background: #fff;
      padding: 0 16px;
      color: #7a7e8c;
      font-size: 14px;
    }
    
    /* Dark theme support for auth modal */
    body.theme-dark .auth-modal {
      background: #23243a;
      color: #f3f6fa;
    }
    
    body.theme-dark .auth-form h2 {
      color: #f3f6fa;
    }
    
    body.theme-dark .auth-field label {
      color: #f3f6fa;
    }
    
    body.theme-dark .auth-field input {
      background: #181824;
      border-color: #35354d;
      color: #f3f6fa;
    }
    
    body.theme-dark .auth-field input:focus {
      border-color: #6a5cff;
      box-shadow: 0 2px 8px rgba(106, 92, 255, 0.25);
    }
    
    body.theme-dark .auth-tabs {
      background: #181824;
    }
    
    body.theme-dark .auth-tab.active {
      background: #35354d;
    }
    
    body.theme-dark .auth-btn.secondary {
      background: #181824;
      color: #f3f6fa;
      border-color: #35354d;
    }
    
    body.theme-dark .auth-btn.secondary:hover {
      background: #35354d;
      border-color: #454565;
    }
    
    body.theme-dark .auth-divider::before {
      background: #35354d;
    }
    
    body.theme-dark .auth-divider span {
      background: #23243a;
    }
    
    body.theme-dark .auth-language-selector label {
      color: #f3f6fa;
    }
    
    body.theme-dark .auth-language-selector select {
      background: #23243a;
      color: #f3f6fa;
      border-color: #35354d;
    }
    
    body.theme-dark .auth-language-selector select:focus {
      border-color: #6a5cff;
      box-shadow: 0 2px 8px rgba(106, 92, 255, 0.25);
    }
    
    @media (max-width: 480px) {
      .auth-modal {
        margin: 16px;
        padding: 24px;
        width: calc(100vw - 32px);
      }
      
      .auth-field input {
        padding: 12px 14px;
      }
      
      .auth-btn {
        padding: 12px 16px;
      }
    }
    /* --- End Authentication Modal Styles --- */
    
    /* --- Terms of Service Modal Styles --- */
    .terms-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2500;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .terms-modal-backdrop.show {
      opacity: 1;
      visibility: visible;
    }
    
    .terms-modal {
      background: #fff;
      border-radius: 20px;
      width: min(800px, 95vw);
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      position: relative;
      box-shadow: 0 24px 64px rgba(0, 0, 0, 0.3);
      transform: scale(0.9) translateY(-20px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .terms-modal-backdrop.show .terms-modal {
      transform: scale(1) translateY(0);
    }
    
    .terms-header {
      padding: 24px 32px;
      border-bottom: 1.5px solid #e3e6ee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .terms-header h2 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      color: #23243a;
    }
    
    .terms-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #888;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .terms-close:hover {
      background: #f3f4f6;
      color: #6a5cff;
    }
    
    .terms-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px 32px;
      scrollbar-width: thin;
      scrollbar-color: #6a5cff #e3e6ee;
    }
    
    .terms-content::-webkit-scrollbar {
      width: 8px;
    }
    
    .terms-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    .terms-content::-webkit-scrollbar-thumb {
      background: #6a5cff;
      border-radius: 4px;
    }
    
    .terms-content::-webkit-scrollbar-thumb:hover {
      background: #5a4cef;
    }
    
    .terms-section {
      margin-bottom: 24px;
    }
    
    .terms-section h3 {
      margin: 0 0 12px 0;
      font-size: 18px;
      font-weight: 600;
      color: #23243a;
      border-left: 3px solid #6a5cff;
      padding-left: 12px;
    }
    
    .terms-section p {
      margin: 0 0 12px 0;
      font-size: 15px;
      line-height: 1.6;
      color: #444;
    }
    
    .terms-section ul {
      margin: 0 0 12px 0;
      padding-left: 20px;
    }
    
    .terms-section li {
      margin-bottom: 8px;
      font-size: 15px;
      line-height: 1.5;
      color: #444;
    }
    
    .terms-footer {
      margin-top: 32px;
      padding-top: 20px;
      border-top: 1.5px solid #e3e6ee;
      text-align: center;
    }
    
    .terms-footer p {
      margin: 0;
      font-size: 13px;
      color: #7a7e8c;
      font-style: italic;
    }
    
    .terms-actions {
      padding: 20px 32px;
      border-top: 1.5px solid #e3e6ee;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .terms-btn {
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }
    
    .terms-btn.primary {
      background: linear-gradient(135deg, #6a5cff 0%, #4f8cff 100%);
      color: #fff;
    }
    
    .terms-btn.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(106, 92, 255, 0.25);
    }
    
    .terms-btn.secondary {
      background: #f8f9fb;
      color: #23243a;
      border: 1.5px solid #e3e6ee;
    }
    
    .terms-btn.secondary:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }
    
    .auth-agreement a {
      color: #6a5cff;
      text-decoration: none;
      font-weight: 500;
    }
    
    .auth-agreement a:hover {
      text-decoration: underline;
    }
    
    /* Dark theme support for terms modal */
    body.theme-dark .terms-modal {
      background: #23243a;
      color: #f3f6fa;
    }
    
    body.theme-dark .terms-header {
      border-bottom-color: #35354d;
    }
    
    body.theme-dark .terms-header h2 {
      color: #f3f6fa;
    }
    
    body.theme-dark .terms-section h3 {
      color: #f3f6fa;
    }
    
    body.theme-dark .terms-section p,
    body.theme-dark .terms-section li {
      color: #d1d5db;
    }
    
    body.theme-dark .terms-footer {
      border-top-color: #35354d;
    }
    
    body.theme-dark .terms-actions {
      border-top-color: #35354d;
    }
    
    body.theme-dark .terms-btn.secondary {
      background: #181824;
      color: #f3f6fa;
      border-color: #35354d;
    }
    
    body.theme-dark .terms-btn.secondary:hover {
      background: #35354d;
      border-color: #454565;
    }
    
    body.theme-dark .terms-close:hover {
      background: #35354d;
      color: #6a5cff;
    }
    
    body.theme-dark .terms-content::-webkit-scrollbar-track {
      background: #35354d;
    }
    
    body.theme-dark .terms-content::-webkit-scrollbar-thumb {
      background: #6a5cff;
    }
    @media (max-width: 768px) {
      .terms-modal {
        margin: 16px;
        width: calc(100vw - 32px);
        max-height: calc(100vh - 32px);
      }
      
      .terms-header {
        padding: 20px 24px;
      }
      
      .terms-content {
        padding: 20px 24px;
      }
      
      .terms-actions {
        padding: 16px 24px;
        flex-direction: column;
      }
      
      .terms-btn {
        width: 100%;
      }
    }
    /* --- End Terms of Service Modal Styles --- */
    body.theme-dark .chat-window {
      background: #181824;
    }
    body.theme-dark .bubble {
      background: #35354d;
      color: #f3f6fa;
      box-shadow: 0 2px 12px 0 rgba(60,60,120,0.18);
    }
    body.theme-dark .msg.you .bubble {
      background: linear-gradient(135deg, #6a5cff 0%, #4f8cff 100%);
      color: #fff;
    }
    body.theme-dark .msg.other .bubble {
      background: #35354d;
      color: #f3f6fa;
    }
    body.theme-dark .msg-time {
      color: #b3b8c5;
    }
    body.theme-dark .read {
      color: #4fff4f;
    }
    body.theme-dark .date-sep {
      color: #b3b8c5;
      background: #23243a;
    }
    body.theme-dark .status {
      color: #b3b8c5;
      background: none;
    }
    body.theme-dark .chat-window::-webkit-scrollbar {
      width: 8px;
      background: #23243a;
      border-radius: 8px;
    }
    body.theme-dark .chat-window::-webkit-scrollbar-thumb {
      background: #6a5cffbb;
      border-radius: 8px;
    }
    body.theme-dark .msg-del-btn, body.theme-dark .msg-info-btn {
      background: #23243a;
      color: #b3b8c5;
    }
    body.theme-dark .msg-del-btn:hover, body.theme-dark .msg-info-btn:hover {
      background: #35354d;
      color: #fff;
    }
    body.theme-dark .reply {
      border-left:2.5px solid #6a5cff;
      color: #b3b8c5;
    }











  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="sidebar">
      <div class="sidebar-header"></div>
      <div class="chat-list">
      </div>
    </div>
    <div class="chat-main">
      <div class="top-nav">
        <div class="nav-tab" data-translate="chats">Чаты</div>
        <div class="nav-tab" data-translate="settings">Настройки</div>
        <div class="nav-menu" id="navMenuBtn" tabindex="0" aria-label="Menu" style="position:relative;cursor:pointer;">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </div>
      </div>
              <div class="chat-container">
          <div class="chat-header">
          </div>
        <select id="roomSelector"><option value="general"># Общий</option><option value="private">🔒 Приват</option></select>
        <input id="nameInput" placeholder="Введите имя" data-translate-placeholder="enterName">
        <div id="chat" class="chat-window"></div>
        <div id="typingStatus" class="status"></div>
        <div class="inputs">
          <button id="quickTranslateBtn" title="Quick translate" aria-label="Quick translate" data-translate-title="quickTranslate">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/><path d="M2 12h20"/></svg>
          </button>
          <input id="messageInput" type="text" placeholder="Сообщение" data-translate-placeholder="messageInput">

          <button id="imageBtn" title="Attach image" aria-label="Attach image" data-translate-title="attachImage">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
          </button><input id="imageInput" type="file" accept="image/*">
          <button id="fileBtn" title="Attach file" aria-label="Attach file" data-translate-title="attachFile">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M16.5 13.5V7.75C16.5 5.68 14.82 4 12.75 4C10.68 4 9 5.68 9 7.75V17C9 18.66 10.34 20 12 20C13.66 20 15 18.66 15 17V9.5"/></svg>
          </button><input id="fileInput" type="file">
          <button id="sendBtn" title="Send" aria-label="Send" data-translate-title="send">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
          <button class="mic-btn" title="Voice message" aria-label="Voice message" data-translate-title="voiceMessage">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="2" width="6" height="12" rx="3"/><path d="M5 10v2a7 7 0 0 0 14 0v-2"/><line x1="12" y1="22" x2="12" y2="18"/><line x1="8" y1="22" x2="16" y2="22"/></svg>
          </button>

        </div>
      </div>
    </div>
  </div>
  
  <!-- Authentication Modal -->
  <div class="auth-modal-backdrop" id="authModalBackdrop">
    <div class="auth-modal" id="authModal">
      <div class="auth-language-selector">
        <label for="authLanguageSelect" data-translate="interfaceLanguage">Язык интерфейса</label>
        <select id="authLanguageSelect" onchange="changeAuthLanguage(this.value)">
          <option value="ru">Русский</option>
          <option value="en">English</option>
          <option value="am">Հայերեն</option>
          <option value="fr">Français</option>
          <option value="de">Deutsch</option>
          <option value="es">Español</option>
        </select>
      </div>
      
      <div class="auth-tabs">
        <button class="auth-tab active" id="loginTab" onclick="switchAuthTab('login')">
          <span data-translate="login">Вход</span>
        </button>
        <button class="auth-tab" id="registerTab" onclick="switchAuthTab('register')">
          <span data-translate="register">Регистрация</span>
        </button>
      </div>

      <!-- Login Form -->
      <div class="auth-form" id="loginForm">
        <h2 data-translate="welcomeBack">Добро пожаловать!</h2>
        <p class="auth-description" data-translate="loginDescription">Войдите в свой аккаунт для продолжения</p>
        
        <div class="auth-field">
          <label for="loginEmail" data-translate="email">Email</label>
          <input type="email" id="loginEmail" placeholder="example@email.com" required>
        </div>
        
        <div class="auth-field">
          <label for="loginPassword" data-translate="password">Пароль</label>
          <input type="password" id="loginPassword" placeholder="••••••••" required>
        </div>
        
        <button class="auth-btn primary" id="loginBtn" onclick="handleLogin()">
          <span data-translate="signIn">Войти</span>
        </button>
        
        <div class="auth-links">
          <a href="#" onclick="showForgotPassword()" data-translate="forgotPassword">Забыли пароль?</a>
        </div>
      </div>

      <!-- Register Form -->
      <div class="auth-form" id="registerForm" style="display: none;">
        <h2 data-translate="createAccount">Создать аккаунт</h2>
        <p class="auth-description" data-translate="registerDescription">Заполните данные для регистрации</p>
        
        <div class="auth-field">
          <label for="registerName" data-translate="fullName">Полное имя</label>
          <input type="text" id="registerName" placeholder="Ваше имя" required>
        </div>
        
        <div class="auth-field">
          <label for="registerEmail" data-translate="email">Email</label>
          <input type="email" id="registerEmail" placeholder="example@email.com" required>
        </div>
        
        <div class="auth-field">
          <label for="registerPassword" data-translate="password">Пароль</label>
          <input type="password" id="registerPassword" placeholder="••••••••" required>
          <small class="field-hint" data-translate="passwordHint">Минимум 6 символов</small>
        </div>
        
        <div class="auth-field">
          <label for="registerConfirmPassword" data-translate="confirmPassword">Подтвердите пароль</label>
          <input type="password" id="registerConfirmPassword" placeholder="••••••••" required>
        </div>
        
        <button class="auth-btn primary" id="registerBtn" onclick="handleRegister()">
          <span data-translate="createAccount">Создать аккаунт</span>
        </button>
        
        <div class="auth-agreement">
          <label class="checkbox-label">
            <input type="checkbox" id="agreeTerms" required>
            <span data-translate="agreeTerms">Я согласен с</span>&nbsp;<a href="#" onclick="showTermsOfService()" data-translate="termsOfService">условиями использования</a>
          </label>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Terms of Service Modal -->
  <div class="terms-modal-backdrop" id="termsModalBackdrop">
    <div class="terms-modal" id="termsModal">
      <div class="terms-header">
        <h2 data-translate="termsOfServiceTitle">Условия использования DuoTalk</h2>
        <button class="terms-close" id="termsModalClose" title="Закрыть">×</button>
      </div>
      
      <div class="terms-content">
        <div class="terms-section">
          <h3 data-translate="acceptance">1. Принятие условий</h3>
          <p data-translate="acceptanceText">Используя DuoTalk, вы соглашаетесь с настоящими условиями использования. Если вы не согласны с какими-либо из этих условий, пожалуйста, не используйте наш сервис.</p>
        </div>

        <div class="terms-section">
          <h3 data-translate="serviceDescription">2. Описание сервиса</h3>
          <p data-translate="serviceDescriptionText">DuoTalk - это платформа для обмена мгновенными сообщениями, которая позволяет пользователям общаться в режиме реального времени. Сервис включает в себя текстовые сообщения, обмен файлами и изображениями.</p>
        </div>

        <div class="terms-section">
          <h3 data-translate="userResponsibilities">3. Обязанности пользователей</h3>
          <p data-translate="userResponsibilitiesText">Пользователи обязуются:</p>
          <ul>
            <li data-translate="responsibility1">Предоставлять точную и актуальную информацию при регистрации</li>
            <li data-translate="responsibility2">Не использовать сервис для незаконной деятельности</li>
            <li data-translate="responsibility3">Уважать права других пользователей</li>
            <li data-translate="responsibility4">Не распространять спам, вредоносное ПО или нежелательный контент</li>
            <li data-translate="responsibility5">Не нарушать авторские права и интеллектуальную собственность</li>
          </ul>
        </div>

        <div class="terms-section">
          <h3 data-translate="privacy">4. Конфиденциальность</h3>
          <p data-translate="privacyText">Мы уважаем вашу конфиденциальность. Все сообщения шифруются для обеспечения безопасности. Мы не передаем ваши личные данные третьим лицам без вашего согласия, за исключением случаев, предусмотренных законом.</p>
        </div>

        <div class="terms-section">
          <h3 data-translate="dataStorage">5. Хранение данных</h3>
          <p data-translate="dataStorageText">Ваши сообщения и данные профиля хранятся на защищенных серверах. Мы принимаем разумные меры для защиты ваших данных от несанкционированного доступа, но не можем гарантировать абсолютную безопасность.</p>
        </div>

        <div class="terms-section">
          <h3 data-translate="prohibitedContent">6. Запрещенный контент</h3>
          <p data-translate="prohibitedContentText">Запрещается размещение следующего контента:</p>
          <ul>
            <li data-translate="prohibited1">Материалы, содержащие угрозы, оскорбления или домогательства</li>
            <li data-translate="prohibited2">Порнографические или неприемлемые материалы</li>
            <li data-translate="prohibited3">Контент, нарушающий авторские права</li>
            <li data-translate="prohibited4">Информация, которая может причинить вред другим пользователям</li>
          </ul>
        </div>

        <div class="terms-section">
          <h3 data-translate="termination">7. Прекращение обслуживания</h3>
          <p data-translate="terminationText">Мы оставляем за собой право приостановить или прекратить ваш доступ к сервису в случае нарушения настоящих условий использования или по другим обоснованным причинам.</p>
        </div>

        <div class="terms-section">
          <h3 data-translate="limitation">8. Ограничение ответственности</h3>
          <p data-translate="limitationText">DuoTalk предоставляется "как есть". Мы не несем ответственности за любой ущерб, возникший в результате использования нашего сервиса, включая потерю данных или прерывание обслуживания.</p>
        </div>

        <div class="terms-section">
          <h3 data-translate="changes">9. Изменения условий</h3>
          <p data-translate="changesText">Мы можем изменять настоящие условия использования в любое время. Продолжение использования сервиса после внесения изменений означает ваше согласие с новыми условиями.</p>
        </div>

        <div class="terms-section">
          <h3 data-translate="contact">10. Контактная информация</h3>
          <p data-translate="contactText">Если у вас есть вопросы относительно настоящих условий использования, вы можете связаться с нами через интерфейс приложения.</p>
        </div>

        <div class="terms-footer">
          <p><span data-translate="lastUpdated">Последнее обновление:</span> <span data-translate="lastUpdatedDate">15 декабря 2024 г.</span></p>
        </div>
      </div>
      
      <div class="terms-actions">
        <button class="terms-btn primary" onclick="acceptTerms()" data-translate="acceptAndClose">Принять и закрыть</button>
        <button class="terms-btn secondary" onclick="hideTermsOfService()" data-translate="close">Закрыть</button>
      </div>
    </div>
  </div>
  
  <!-- Quick Translate Modal -->
  <div class="quick-translate-modal" id="quickTranslateModal">
    <div class="quick-translate-content">
      <div class="quick-translate-header">
        <h3 class="quick-translate-title" data-translate="quickTranslate">Быстрый перевод</h3>
        <button class="quick-translate-close" onclick="hideQuickTranslate()">×</button>
      </div>
      
      <!-- Language Selection -->
      <div class="translate-language-section">
        <div class="language-selector-group">
          <label for="sourceLanguageSelect" data-translate="sourceLanguage">Исходный язык</label>
          <select id="sourceLanguageSelect" onchange="onLanguageChange()">
            <option value="auto" data-translate="autoDetect">🔍 Автоопределение</option>
            <option value="ru">🇷🇺 Русский</option>
            <option value="en">🇺🇸 English</option>
            <option value="am">🇦🇲 Հայերեն</option>
            <option value="fr">🇫🇷 Français</option>
            <option value="de">🇩🇪 Deutsch</option>
            <option value="es">🇪🇸 Español</option>
            <option value="it">🇮🇹 Italiano</option>
            <option value="pt">🇵🇹 Português</option>
            <option value="zh">🇨🇳 中文</option>
            <option value="ja">🇯🇵 日本語</option>
            <option value="ko">🇰🇷 한국어</option>
            <option value="ar">🇸🇦 العربية</option>
          </select>
        </div>
        <div class="language-swap">
          <button id="swapLanguagesBtn" onclick="swapLanguages()" title="Поменять языки местами">⇄</button>
        </div>
        <div class="language-selector-group">
          <label for="targetLanguageSelect" data-translate="targetLanguage">Целевой язык</label>
          <select id="targetLanguageSelect" onchange="onLanguageChange()">
            <option value="ru">🇷🇺 Русский</option>
            <option value="en">🇺🇸 English</option>
            <option value="am">🇦🇲 Հայերեն</option>
            <option value="fr">🇫🇷 Français</option>
            <option value="de">🇩🇪 Deutsch</option>
            <option value="es">🇪🇸 Español</option>
            <option value="it">🇮🇹 Italiano</option>
            <option value="pt">🇵🇹 Português</option>
            <option value="zh">🇨🇳 中文</option>
            <option value="ja">🇯🇵 日本語</option>
            <option value="ko">🇰🇷 한국어</option>
            <option value="ar">🇸🇦 العربية</option>
          </select>
        </div>
      </div>
      
      <div class="translate-section">
        <label for="originalTextArea" data-translate="originalText">Исходный текст</label>
        <textarea id="originalTextArea" placeholder="Введите текст для перевода..."></textarea>
        <div class="detected-language" id="detectedLanguage" style="display: none;">
          <span data-translate="detectedLanguage">Обнаружен язык:</span> <span id="detectedLanguageName"></span>
        </div>
      </div>
      
      <div class="translate-section">
        <label for="translatedTextArea" data-translate="translatedText">Переведенный текст</label>
        <textarea id="translatedTextArea" readonly placeholder="Перевод появится здесь..."></textarea>
      </div>
      
      <div class="translate-actions">
        <button class="translate-btn-action translate-btn-secondary" onclick="hideQuickTranslate()" data-translate="close">Закрыть</button>
        <button class="translate-btn-action translate-btn-primary" onclick="useTranslatedText()" data-translate="translateBeforeSend">Перевести перед отправкой</button>
      </div>
    </div>
  </div>
  
  <div class="theme-menu-backdrop" id="themeMenuBackdrop"></div>
  <div class="theme-menu" id="themeMenu">
    <button class="theme-menu-close" id="themeMenuClose" title="Закрыть" data-translate-title="close">×</button>
    <div class="theme-menu-title" data-translate="theme">Тема оформления</div>
    <label class="theme-switcher"><input type="radio" name="theme" value="light" id="themeLight"><span class="theme-switcher-label" data-translate="lightMode">Светлая</span></label>
    <label class="theme-switcher"><input type="radio" name="theme" value="dark" id="themeDark"><span class="theme-switcher-label" data-translate="darkMode">Тёмная</span></label>
    <label class="theme-switcher"><input type="radio" name="theme" value="auto" id="themeAuto"><span class="theme-switcher-label" data-translate="autoMode">Авто</span></label>
  </div>

  <!-- Библиотеки загружаются синхронно для правильной работы -->
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>



  <script>
  // Auto-detect user language or default to English
  function detectUserLanguage() {
    // Check if language is already saved
    const savedLanguage = localStorage.getItem('language');
    if (savedLanguage) {
      return savedLanguage;
    }
    
    // Auto-detect from browser language
    const browserLang = navigator.language || navigator.userLanguage;
    const langCode = browserLang.split('-')[0].toLowerCase();
    
    // Map browser languages to supported languages
    const supportedLanguages = ['ru', 'en', 'am', 'fr', 'de', 'es'];
    
    // Return detected language if supported, otherwise default to English
    return supportedLanguages.includes(langCode) ? langCode : 'en';
  }

  // Глобальные переменные
  let currentLanguage = detectUserLanguage();
  let room = "general", lastSent = 0, typingTimer, replyTo = null, currentView = "chats";
  let currentUser = null, isAuthenticated = false;


  // Проверка готовности библиотек и инициализация
  function initializeApp() {
    if (typeof firebase === 'undefined' || typeof CryptoJS === 'undefined' || typeof markdownit === 'undefined') {
      console.log('Ожидание загрузки библиотек...');
      setTimeout(initializeApp, 100);
      return;
    }

  // Firebase конфигурация
  firebase.initializeApp({
    apiKey: "AIzaSyBVxz1vJdIjTQxBrATy420V8nk9lAuS1iY",
    authDomain: "newviber-41fb4.firebaseapp.com",
    databaseURL: "https://newviber-41fb4-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "newviber-41fb4",
    storageBucket: "newviber-41fb4.appspot.com",
    messagingSenderId: "385554214781",
    appId: "1:385554214781:web:1b4048a9b5fd1142fba614"
  });

  // Утилиты
    window.db = firebase.database();
    window.secret = "viberCloneKey";
    window.md = markdownit();
    window.enc = t => CryptoJS.AES.encrypt(t, window.secret).toString();
    window.dec = c => { 
      try{ 
        return CryptoJS.AES.decrypt(c, window.secret).toString(CryptoJS.enc.Utf8); 
      } catch { 
        return "(decrypt error)"; 
      } 
    };
    window.parse = text => window.md.renderInline(text);
    
    console.log('Приложение инициализировано');
  }

  // Запуск инициализации
  initializeApp();
  const fmtTime = ts => {
    const locale = getDateLocale(currentLanguage);
    const timeFormat = getTimeFormat(currentLanguage);
    
    const options = {
      hour: '2-digit', 
      minute: '2-digit',
      hour12: timeFormat.hour12
    };
    
    let timeString = new Date(ts).toLocaleTimeString(locale, options);
    
    // Special formatting for French (replace : with h)
    if (currentLanguage === 'fr' && timeFormat.separator === 'h') {
      timeString = timeString.replace(':', 'h');
    }
    
    return timeString;
  };
  const sepText = ts => {
    const diff = (new Date().setHours(0,0,0,0) - new Date(ts).setHours(0,0,0,0))/86400000;
    const t = translations[currentLanguage] || translations.en;
    if (diff === 0) return t.today;
    if (diff === 1) return t.yesterday;
    // Format date according to current language
    const date = new Date(ts);
    const options = { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    };
    return date.toLocaleDateString(getDateLocale(currentLanguage), options);
  };
  // Helper function to get proper locale for date formatting
  function getDateLocale(lang) {
    const localeMap = {
      ru: 'ru-RU',
      en: 'en-US', 
      am: 'hy-AM',
      fr: 'fr-FR',
      de: 'de-DE',
      es: 'es-ES'
    };
    return localeMap[lang] || 'en-US';
  }

  // Helper function to get time formatting preferences by region
  function getTimeFormat(lang) {
    const timeFormats = {
      ru: { hour12: false, separator: ':' },      // 24-hour format (15:30)
      en: { hour12: true, separator: ':' },       // 12-hour format (3:30 PM)
      am: { hour12: false, separator: ':' },      // 24-hour format (15:30)
      fr: { hour12: false, separator: 'h' },      // 24-hour format (15h30)
      de: { hour12: false, separator: ':' },      // 24-hour format (15:30)
      es: { hour12: false, separator: ':' }       // 24-hour format (15:30)
    };
    return timeFormats[lang] || timeFormats.en;
  }



  // Кэшированные DOM элементы
  const elements = {
    chatList: () => document.querySelector('.chat-list'),
    nameInput: () => document.getElementById('nameInput'),
    messageInput: () => document.getElementById('messageInput'),
    chat: () => document.getElementById('chat'),
    typingStatus: () => document.getElementById('typingStatus')
  };

  // Update sidebar with real users
  function updateSidebar() {
    const chatList = elements.chatList();
    chatList.innerHTML = '';
    const me = elements.nameInput().value.trim();
    const t = translations[currentLanguage] || translations.en;
    
    // Collect unique users from messages
    window.db.ref(`rooms/${room}/messages`).once('value', snap => {
      const users = new Set();
      snap.forEach(child => {
        const m = child.val();
        if (m.name === me || m.name) users.add(m.name);
      });
      // Remove self from the set if you only want to show other users
      // users.delete(me);
      if (users.size === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.className = 'chat-list-item';
        emptyMsg.style.justifyContent = 'center';
        emptyMsg.style.color = '#aaa';
        emptyMsg.textContent = t.noChatsYet || 'No chats yet';
        chatList.appendChild(emptyMsg);
        return;
      }
      users.forEach(user => {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-list-item';
        if (user === me) chatItem.classList.add('selected');
        const avatar = document.createElement('div');
        avatar.className = 'avatar avatar-placeholder';
        avatar.textContent = user.charAt(0).toUpperCase();
        const info = document.createElement('div');
        info.className = 'chat-list-info';
        const name = document.createElement('div');
        name.className = 'chat-list-name';
        name.textContent = user;
        info.appendChild(name);
        chatItem.appendChild(avatar);
        chatItem.appendChild(info);
        chatList.appendChild(chatItem);
      });
    });
  }

  // Navigation functionality
  function switchView(view, event) {
    console.log('switchView called with:', view);
    currentView = view;
    // Update active tab
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    if (event && event.target) event.target.classList.add('active');

    // Remove settings panel if present
    const existingSettings = document.querySelector('.settings-panel');
    if (existingSettings) {
      console.log('Removing existing settings panel');
      existingSettings.remove();
    }

    // Show/hide elements based on view
    const chatContainer = document.querySelector('.chat-container');
    const chatList = document.querySelector('.chat-list');
    const sidebarHeader = document.querySelector('.sidebar-header');
    
    switch(view) {
      case 'chats':
        console.log('Switching to chats view');
        sidebarHeader.style.display = 'none';
        chatList.style.display = 'block';
        chatContainer.style.display = 'flex';
        chatContainer.style.visibility = 'visible';
        updateSidebar();
        break;
      case 'settings':
        console.log('Switching to settings view');
        sidebarHeader.style.display = 'none';
        chatList.style.display = 'none';
        chatContainer.style.display = 'none';
        chatContainer.style.visibility = 'hidden';
        showSettings();
        break;
    }
  }

  function showSettings() {
    const chatMain = document.querySelector('.chat-main');
    if (!chatMain) {
      console.error('Element .chat-main not found');
      return;
    }
    
    const existingSettings = document.querySelector('.settings-panel');
    if (existingSettings) {
      existingSettings.style.display = 'block';
      loadSettings(); 
      return;
    }
    
    const settingsPanel = document.createElement('div');
    settingsPanel.className = 'settings-panel';
    settingsPanel.innerHTML = `
      <div class="settings-content">
        <div class="settings-sidebar">
          <div class="settings-nav">
            <div class="settings-nav-item active" data-section="profile" onclick="switchSettingsSection('profile')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <span data-translate="profile">Профиль</span>
            </div>
            <div class="settings-nav-item" data-section="chat" onclick="switchSettingsSection('chat')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              <span data-translate="chat">Чат</span>
            </div>
            <div class="settings-nav-item" data-section="notifications" onclick="switchSettingsSection('notifications')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
              </svg>
              <span data-translate="notifications">Уведомления</span>
            </div>
            <div class="settings-nav-item" data-section="security" onclick="switchSettingsSection('security')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
              <span data-translate="security">Безопасность</span>
            </div>

            <button class="settings-logout-btn" onclick="logoutUser()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              <span data-translate="logout">Выйти</span>
            </button>
            
            <button class="settings-save-btn" onclick="saveSettings()" id="settingsSaveBtn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
              </svg>
              <span data-translate="saveChanges">Сохранить</span>
            </button>
          </div>
        </div>

        <div class="settings-main">
          <div class="settings-header">
            <h2 data-translate="settings">Настройки</h2>
            <p class="settings-description" data-translate="settingsDescription">Настройте чат под себя для комфортного общения</p>
          </div>

          <!-- Секция Профиль -->
          <div class="settings-section" id="section-profile">
            <div class="settings-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <span data-translate="profile">Профиль</span>
            </div>
            <div class="setting-item">
              <label for="settingsName" data-translate="yourName">Ваше имя</label>
              <input type="text" id="settingsName">
              <p class="setting-item-description" data-translate="nameDescription">Это имя будут видеть другие пользователи</p>
            </div>
            <div class="setting-item">
              <label for="settingsStatus" data-translate="status">Статус</label>
              <select id="settingsStatus">
                <option value="online" data-translate="online">🟢 В сети</option>
                <option value="away" data-translate="away">🌙 Отошёл</option>
                <option value="busy" data-translate="busy">⛔ Не беспокоить</option>
                <option value="invisible" data-translate="invisible">👻 Невидимка</option>
              </select>
            </div>
            <div class="setting-item">
              <label for="settingsLanguage" data-translate="interfaceLanguage">Язык интерфейса</label>
              <select id="settingsLanguage" onchange="updateUILanguage(this.value)">
                <option value="ru">Русский</option>
                <option value="en">English</option>
                <option value="am">Հայերեն</option>
                <option value="fr">Français</option>
                <option value="de">Deutsch</option>
                <option value="es">Español</option>
              </select>
            </div>



          </div>

          <!-- Секция Чат -->
          <div class="settings-section" id="section-chat" style="display: none;">
            <div class="settings-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              <span data-translate="chat">Чат</span>
            </div>
            <div class="setting-item">
              <label for="settingsRoom" data-translate="room">Комната</label>
              <select id="settingsRoom">
                <option value="general" data-translate="general">💬 Общий чат</option>
                <option value="private" data-translate="private">🔒 Приватный чат</option>
                <option value="games" data-translate="games">🎮 Игры</option>
                <option value="music" data-translate="music">🎵 Музыка</option>
              </select>
              <p class="setting-item-description" data-translate="roomDescription">Выберите комнату для общения</p>
            </div>
            <div class="setting-item">
              <label class="checkbox-label">
                <input type="checkbox" id="settingsTyping" checked>
                <span data-translate="showTypingStatus">Показывать статус печати</span>
              </label>
            </div>
          </div>

          <!-- Секция Уведомления -->
          <div class="settings-section" id="section-notifications" style="display: none;">
            <div class="settings-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
              </svg>
              <span data-translate="notifications">Уведомления</span>
            </div>
            <div class="setting-item">
              <label class="checkbox-label">
                <input type="checkbox" id="settingsNotifications" checked>
                <span data-translate="enableNotifications">Включить уведомления</span>
              </label>
              <p class="setting-item-description" data-translate="notificationsDescription">Получать уведомления о новых сообщениях</p>
            </div>
            <div class="setting-item">
              <label class="checkbox-label">
                <input type="checkbox" id="settingsSound" checked>
                <span data-translate="soundNotifications">Звуковые уведомления</span>
              </label>
            </div>
          </div>

          <!-- Секция Безопасность -->
          <div class="settings-section" id="section-security" style="display: none;">
            <div class="settings-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
              <span data-translate="security">Безопасность</span>
            </div>
            <div class="setting-item">
              <label class="checkbox-label">
                <input type="checkbox" id="settingsEncryption" checked>
                <span data-translate="messageEncryption">Шифрование сообщений</span>
              </label>
              <p class="setting-item-description" data-translate="encryptionDescription">Все сообщения будут зашифрованы</p>
            </div>
            <div class="setting-item">
              <label class="checkbox-label">
                <input type="checkbox" id="settingsPrivateMode">
                <span data-translate="privateMode">Приватный режим</span>
              </label>
              <p class="setting-item-description" data-translate="privateModeDescription">Скрыть историю чата при выходе</p>
            </div>
          </div>
          
        </div>


      </div>
    `;
    
    chatMain.appendChild(settingsPanel);
    
    // Load current settings
    document.getElementById('settingsName').value = document.getElementById('nameInput').value;
    document.getElementById('settingsRoom').value = room;
    
    // Set language and update UI
    const savedLanguage = localStorage.getItem('language') || currentLanguage;
    document.getElementById('settingsLanguage').value = savedLanguage;
    updateUILanguage(savedLanguage);
    
    // Инициализируем отображение - показываем только секцию профиля
    switchSettingsSection('profile');
    
    console.log('Settings panel created and added to DOM');
  }

  // Функция выхода из аккаунта
  function logoutUser() {
    if (confirm('Вы действительно хотите выйти?')) {
      // Очищаем данные пользователя
      localStorage.removeItem('chatName');
      localStorage.removeItem('userStatus');
      localStorage.removeItem('notifications');
      localStorage.removeItem('currentUser');
      localStorage.removeItem('userToken');
      
      // Сбрасываем глобальные переменные
      currentUser = null;
      isAuthenticated = false;
      
      // Перезагружаем страницу
      window.location.reload();
    }
  }

  // Функция для переключения секций настроек
  function switchSettingsSection(sectionName) {
    // Обновляем активный элемент навигации
    document.querySelectorAll('.settings-nav-item').forEach(item => {
      item.classList.toggle('active', item.dataset.section === sectionName);
    });

    // Скрываем все секции и показываем нужную
    document.querySelectorAll('.settings-section').forEach(section => {
      section.style.display = 'none';
      section.style.opacity = '0';
    });
    
    const targetSection = document.getElementById('section-' + sectionName);
    if (targetSection) {
      targetSection.style.display = 'block';
    
    // Анимация появления
    setTimeout(() => {
        targetSection.style.opacity = '1';
        targetSection.style.transition = 'opacity 0.3s ease';
    }, 50);
    }
  }

  function loadSettings() {
    // Загружаем имя пользователя
    const name = localStorage.chatName || '';
    document.getElementById('settingsName').value = name;

    // Загружаем статус
    const status = localStorage.userStatus || 'online';
    document.getElementById('settingsStatus').value = status;

    // Загружаем выбранную комнату
    document.getElementById('settingsRoom').value = room;

    // Загружаем настройки уведомлений
    try {
      const notifications = JSON.parse(localStorage.notifications || '{}');
      document.getElementById('settingsNotifications').checked = notifications.enabled ?? true;
      document.getElementById('settingsSound').checked = notifications.sound ?? true;
      document.getElementById('settingsTyping').checked = notifications.typing ?? true;
    } catch (e) {
      console.error('Ошибка при загрузке настроек уведомлений:', e);
    }

    // Загружаем настройки безопасности
    document.getElementById('settingsEncryption').checked = localStorage.encryption !== 'false';
    document.getElementById('settingsPrivateMode').checked = localStorage.privateMode === 'true';
  }

  // Object with UI translations
  // Initialize UI with current language on load
  document.addEventListener('DOMContentLoaded', () => {
    // Save the detected/current language to localStorage
    localStorage.setItem('language', currentLanguage);
    
    // Update UI with current language
    updateUILanguage(currentLanguage);
    
    // Show notification about detected language (only for first-time users)
    if (!localStorage.getItem('languageNotified')) {
      setTimeout(() => {
        const t = translations[currentLanguage] || translations.en;
        const languageNames = {
          'ru': 'Русский',
          'en': 'English', 
          'am': 'Հայերեն',
          'fr': 'Français',
          'de': 'Deutsch',
          'es': 'Español'
        };
        
        showToast(`${t.languageDetected || 'Language detected'}: ${languageNames[currentLanguage]}`, 'info');
        localStorage.setItem('languageNotified', 'true');
      }, 2000);
    }
  });
  // Переводы (расширенные)
  const translations = {
    ru: {
      chats: "Чаты", settings: "Настройки", profile: "Профиль", chat: "Чат",
      notifications: "Уведомления", security: "Безопасность", yourName: "Ваше имя",
      status: "Статус", interfaceLanguage: "Язык интерфейса", room: "Комната",
      general: "💬 Общий чат", private: "🔒 Приватный чат", logout: "Выйти",
      saveChanges: "Сохранить", settingsSaved: "Настройки успешно сохранены", messageInput: "Сообщение", send: "Отправить",
      settingsDescription: "Настройте чат под себя для комфортного общения",
      enterName: "Введите имя", attachImage: "Прикрепить изображение",
      attachFile: "Прикрепить файл", voiceMessage: "Голосовое сообщение",
      noChatsYet: "Пока нет чатов", close: "Закрыть", darkMode: "Темная",
      lightMode: "Светлая", autoMode: "Авто", theme: "Тема оформления",
      online: "🟢 В сети", away: "🌙 Отошёл", busy: "⛔ Не беспокоить", 
      invisible: "👻 Невидимка", games: "🎮 Игры", music: "🎵 Музыка",
      nameDescription: "Это имя будут видеть другие пользователи",
      roomDescription: "Выберите комнату для общения",
      showTypingStatus: "Показывать статус печати",
      enableNotifications: "Включить уведомления",
      notificationsDescription: "Получать уведомления о новых сообщениях",
      soundNotifications: "Звуковые уведомления",
      messageEncryption: "Шифрование сообщений",
      encryptionDescription: "Все сообщения будут зашифрованы",
      privateMode: "Приватный режим",
      privateModeDescription: "Скрыть историю чата при выходе",
      translate: "Перевести",
      quickTranslate: "Быстрый перевод",
      translateBeforeSend: "Перевести перед отправкой",
      originalText: "Исходный текст",
      translatedText: "Переведенный текст",
      sourceLanguage: "Исходный язык",
      targetLanguage: "Целевой язык",
      autoDetect: "🔍 Автоопределение",
      detectedLanguage: "Обнаружен язык:",
      sent: "отправлено",
      status: "Статус",
      read: "Прочитано",
      people: "чел.",
      today: "Сегодня",
      yesterday: "Вчера",
      isTyping: "печатает...",
      // Authentication
      login: "Вход",
      register: "Регистрация",
      welcomeBack: "Добро пожаловать!",
      loginDescription: "Войдите в свой аккаунт для продолжения",
      createAccount: "Создать аккаунт",
      registerDescription: "Заполните данные для регистрации",
      email: "Email",
      password: "Пароль",
      fullName: "Полное имя",
      confirmPassword: "Подтвердите пароль",
      passwordHint: "Минимум 6 символов",
      signIn: "Войти",
      agreeTerms: "Я согласен с",
      termsOfService: "условиями использования",
      termsAccepted: "Условия использования приняты",
      forgotPassword: "Забыли пароль?",
      // Terms of Service
      termsOfServiceTitle: "Условия использования DuoTalk",
      acceptAndClose: "Принять и закрыть",
      acceptance: "1. Принятие условий",
      acceptanceText: "Используя DuoTalk, вы соглашаетесь с настоящими условиями использования. Если вы не согласны с какими-либо из этих условий, пожалуйста, не используйте наш сервис.",
      serviceDescription: "2. Описание сервиса",
      serviceDescriptionText: "DuoTalk - это платформа для обмена мгновенными сообщениями, которая позволяет пользователям общаться в режиме реального времени. Сервис включает в себя текстовые сообщения, обмен файлами и изображениями.",
      userResponsibilities: "3. Обязанности пользователей",
      userResponsibilitiesText: "Пользователи обязуются:",
      responsibility1: "Предоставлять точную и актуальную информацию при регистрации",
      responsibility2: "Не использовать сервис для незаконной деятельности",
      responsibility3: "Уважать права других пользователей",
      responsibility4: "Не распространять спам, вредоносное ПО или нежелательный контент",
      responsibility5: "Не нарушать авторские права и интеллектуальную собственность",
      privacy: "4. Конфиденциальность",
      privacyText: "Мы уважаем вашу конфиденциальность. Все сообщения шифруются для обеспечения безопасности. Мы не передаем ваши личные данные третьим лицам без вашего согласия, за исключением случаев, предусмотренных законом.",
      dataStorage: "5. Хранение данных",
      dataStorageText: "Ваши сообщения и данные профиля хранятся на защищенных серверах. Мы принимаем разумные меры для защиты ваших данных от несанкционированного доступа, но не можем гарантировать абсолютную безопасность.",
      prohibitedContent: "6. Запрещенный контент",
      prohibitedContentText: "Запрещается размещение следующего контента:",
      prohibited1: "Материалы, содержащие угрозы, оскорбления или домогательства",
      prohibited2: "Порнографические или неприемлемые материалы",
      prohibited3: "Контент, нарушающий авторские права",
      prohibited4: "Информация, которая может причинить вред другим пользователям",
      termination: "7. Прекращение обслуживания",
      terminationText: "Мы оставляем за собой право приостановить или прекратить ваш доступ к сервису в случае нарушения настоящих условий использования или по другим обоснованным причинам.",
      limitation: "8. Ограничение ответственности",
      limitationText: "DuoTalk предоставляется \"как есть\". Мы не несем ответственности за любой ущерб, возникший в результате использования нашего сервиса, включая потерю данных или прерывание обслуживания.",
      changes: "9. Изменения условий",
      changesText: "Мы можем изменять настоящие условия использования в любое время. Продолжение использования сервиса после внесения изменений означает ваше согласие с новыми условиями.",
      contact: "10. Контактная информация",
      contactText: "Если у вас есть вопросы относительно настоящих условий использования, вы можете связаться с нами через интерфейс приложения.",
      lastUpdated: "Последнее обновление:",
      lastUpdatedDate: "15 декабря 2024 г.",
      // Validation messages
      emailRequired: "Введите email",
      passwordRequired: "Введите пароль",
      nameRequired: "Введите имя",
      passwordsNoMatch: "Пароли не совпадают",
      agreeTermsRequired: "Необходимо согласиться с условиями",
      registrationSuccess: "Регистрация успешна!",
      loginSuccess: "Вход выполнен!",
      invalidCredentials: "Неверные данные для входа",
      emailExists: "Пользователь с таким email уже существует",
      languageChanged: "Язык изменен",
      languageDetected: "Определен язык"
    },
    en: {
      chats: "Chats", settings: "Settings", profile: "Profile", chat: "Chat",
      notifications: "Notifications", security: "Security", yourName: "Your name",
      status: "Status", interfaceLanguage: "Interface language", room: "Room",
      general: "💬 General chat", private: "🔒 Private chat", logout: "Logout",
      saveChanges: "Save", settingsSaved: "Settings saved successfully", messageInput: "Message", send: "Send",
      settingsDescription: "Customize your chat for comfortable communication",
      enterName: "Enter name", attachImage: "Attach image",
      attachFile: "Attach file", voiceMessage: "Voice message",
      noChatsYet: "No chats yet", close: "Close", darkMode: "Dark",
      lightMode: "Light", autoMode: "Auto", theme: "Theme",
      online: "🟢 Online", away: "🌙 Away", busy: "⛔ Do not disturb", 
      invisible: "👻 Invisible", games: "🎮 Games", music: "🎵 Music",
      nameDescription: "This name will be visible to other users",
      roomDescription: "Choose a room for communication",
      showTypingStatus: "Show typing status",
      enableNotifications: "Enable notifications",
      notificationsDescription: "Receive notifications about new messages",
      soundNotifications: "Sound notifications",
      messageEncryption: "Message encryption",
      encryptionDescription: "All messages will be encrypted",
      privateMode: "Private mode",
      privateModeDescription: "Hide chat history on exit",
      translate: "Translate",
      quickTranslate: "Quick translate",
      translateBeforeSend: "Translate before send",
      originalText: "Original text",
      translatedText: "Translated text",
      sourceLanguage: "Source language",
      targetLanguage: "Target language",
      autoDetect: "🔍 Auto-detect",
      detectedLanguage: "Detected language:",
      sent: "sent",
      status: "Status",
      read: "Read",
      people: "people",
      today: "Today",
      yesterday: "Yesterday",
      isTyping: "is typing...",
      // Authentication
      login: "Login",
      register: "Register",
      welcomeBack: "Welcome back!",
      loginDescription: "Sign in to your account to continue",
      createAccount: "Create Account",
      registerDescription: "Fill in the details to register",
      email: "Email",
      password: "Password",
      fullName: "Full Name",
      confirmPassword: "Confirm Password",
      passwordHint: "Minimum 6 characters",
      signIn: "Sign In",
      agreeTerms: "I agree to the",
      termsOfService: "terms of service",
      termsAccepted: "Terms of service accepted",
      forgotPassword: "Forgot password?",
      // Terms of Service
      termsOfServiceTitle: "DuoTalk Terms of Service",
      acceptAndClose: "Accept and Close",
      acceptance: "1. Acceptance of Terms",
      acceptanceText: "By using DuoTalk, you agree to these terms of service. If you do not agree to any of these terms, please do not use our service.",
      serviceDescription: "2. Service Description",
      serviceDescriptionText: "DuoTalk is an instant messaging platform that allows users to communicate in real time. The service includes text messages, file and image sharing.",
      userResponsibilities: "3. User Responsibilities",
      userResponsibilitiesText: "Users are required to:",
      responsibility1: "Provide accurate and current information during registration",
      responsibility2: "Not use the service for illegal activities",
      responsibility3: "Respect the rights of other users",
      responsibility4: "Not distribute spam, malware or unwanted content",
      responsibility5: "Not violate copyrights and intellectual property",
      privacy: "4. Privacy",
      privacyText: "We respect your privacy. All messages are encrypted for security. We do not share your personal data with third parties without your consent, except as required by law.",
      dataStorage: "5. Data Storage",
      dataStorageText: "Your messages and profile data are stored on secure servers. We take reasonable measures to protect your data from unauthorized access, but cannot guarantee absolute security.",
      prohibitedContent: "6. Prohibited Content",
      prohibitedContentText: "The following content is prohibited:",
      prohibited1: "Materials containing threats, insults or harassment",
      prohibited2: "Pornographic or inappropriate materials",
      prohibited3: "Content that violates copyright",
      prohibited4: "Information that may harm other users",
      termination: "7. Service Termination",
      terminationText: "We reserve the right to suspend or terminate your access to the service in case of violation of these terms of use or for other reasonable reasons.",
      limitation: "8. Limitation of Liability",
      limitationText: "DuoTalk is provided \"as is\". We are not responsible for any damage resulting from the use of our service, including data loss or service interruption.",
      changes: "9. Changes to Terms",
      changesText: "We may change these terms of use at any time. Continued use of the service after changes means your agreement to the new terms.",
      contact: "10. Contact Information",
      contactText: "If you have questions about these terms of use, you can contact us through the application interface.",
      lastUpdated: "Last updated:",
      lastUpdatedDate: "December 15, 2024",
      // Validation messages
      emailRequired: "Email is required",
      passwordRequired: "Password is required", 
      nameRequired: "Name is required",
      passwordsNoMatch: "Passwords do not match",
      agreeTermsRequired: "You must agree to the terms",
      registrationSuccess: "Registration successful!",
      loginSuccess: "Login successful!",
      invalidCredentials: "Invalid credentials",
      emailExists: "User with this email already exists",
      languageChanged: "Language changed",
      languageDetected: "Language detected"
    },
    am: {
      chats: "Չատեր", settings: "Կարգավորումներ", profile: "Պրոֆիլ", chat: "Չատ",
      notifications: "Ծանուցումներ", security: "Անվտանգություն", yourName: "Ձեր անունը",
      status: "Կարգավիճակ", interfaceLanguage: "Ինտերֆեյսի լեզու", room: "Սենյակ",
      general: "💬 Ընդհանուր չատ", private: "🔒 Մասնավոր չատ", logout: "Ելք",
      saveChanges: "Պահպանել", settingsSaved: "Կարգավորումները հաջողությամբ պահպանվել են", messageInput: "Հաղորդագրություն", send: "Ուղարկել",
      settingsDescription: "Հարմարեցրեք չատը ձեր համար",
      enterName: "Մուտքագրեք անունը", attachImage: "Կցել նկար",
      attachFile: "Կցել ֆայլ", voiceMessage: "Ձայնային հաղորդագրություն",
      noChatsYet: "Դեռ չատեր չկան", close: "Փակել", darkMode: "Մուգ",
      lightMode: "Բաց", autoMode: "Ավտո", theme: "Թեմա",
      online: "🟢 Կապված", away: "🌙 Հեռացած", busy: "⛔ Չխանգարել", 
      invisible: "👻 Անտեսանելի", games: "🎮 Խաղեր", music: "🎵 Երաժշտություն",
      nameDescription: "Այս անունը կտեսնեն մյուս օգտատերերը",
      roomDescription: "Ընտրեք սենյակ հաղորդակցության համար",
      showTypingStatus: "Ցույց տալ մուտքագրման կարգավիճակը",
      enableNotifications: "Միացնել ծանուցումները",
      notificationsDescription: "Ստանալ ծանուցումներ նոր հաղորդագրությունների մասին",
      soundNotifications: "Ձայնային ծանուցումներ",
      messageEncryption: "Հաղորդագրությունների գաղտնագրում",
      encryptionDescription: "Բոլոր հաղորդագրությունները կգաղտնագրվեն",
      privateMode: "Մասնավոր ռեժիմ",
      privateModeDescription: "Թաքցնել չատի պատմությունը ելքի ժամանակ",
      translate: "Թարգմանել",
      quickTranslate: "Արագ թարգմանություն",
      translateBeforeSend: "Թարգմանել ուղարկելուց առաջ",
      originalText: "Բնօրինակ տեքստ",
      translatedText: "Թարգմանված տեքստ",
      sourceLanguage: "Սկզբնական լեզու",
      targetLanguage: "Նպատակային լեզու",
      autoDetect: "🔍 Ավտոմատ հայտնաբերում",
      detectedLanguage: "Հայտնաբերված լեզու:",
      sent: "ուղարկված",
      status: "Կարգավիճակ",
      read: "Կարդացված",
      people: "մարդ",
      today: "Այսօր",
      yesterday: "Երեկ",
      isTyping: "մուտքագրում է...",
      // Authentication
      login: "Մուտք",
      register: "Գրանցում",
      welcomeBack: "Բարի գալուստ!",
      loginDescription: "Մուտք գործեք ձեր հաշիվ",
      createAccount: "Ստեղծել հաշիվ",
      registerDescription: "Լրացրեք տվյալները գրանցման համար",
      email: "Էլ. փոստ",
      password: "Գաղտնաբառ",
      fullName: "Լրիվ անուն",
      confirmPassword: "Հաստատել գաղտնաբառը",
      passwordHint: "Նվազագույնը 6 նիշ",
      signIn: "Մուտք գործել",
      agreeTerms: "Ես համաձայն եմ",
      termsOfService: "օգտագործման պայմանների հետ",
      forgotPassword: "Մոռացե՞լ եք գաղտնաբառը:",
      // Terms of Service
      termsOfServiceTitle: "DuoTalk օգտագործման պայմաններ",
      acceptAndClose: "Ընդունել և փակել",
      lastUpdated: "Վերջին թարմացում:",
      lastUpdatedDate: "15 դեկտեմբերի, 2024 թ.",
      acceptance: "1. Պայմանների ընդունում",
      acceptanceText: "DuoTalk-ն օգտագործելիս դուք համաձայնվում եք այս օգտագործման պայմանների հետ: Եթե դուք չեք համաձայնում այս պայմանների հետ, խնդրում ենք չօգտագործել մեր ծառայությունը:",
      serviceDescription: "2. Ծառայության նկարագրություն",
      serviceDescriptionText: "DuoTalk-ը հաղորդագրությունների փոխանակման հարթակ է, որը թույլ է տալիս օգտատերերին հաղորդակցել իրական ժամանակում: Ծառայությունը ներառում է տեքստային հաղորդագրություններ, ֆայլերի և նկարների փոխանակում:",
      userResponsibilities: "3. Օգտատերերի պարտականություններ",
      userResponsibilitiesText: "Օգտատերերն պարտավորվում են՝",
      responsibility1: "Գրանցման ժամանակ տրամադրել ճշգրիտ և արդի տեղեկություններ",
      responsibility2: "Չօգտագործել ծառայությունը անօրինական գործունեության համար",
      responsibility3: "Հարգել այլ օգտատերերի իրավունքները",
      responsibility4: "Չտարածել սպամ, վնասակար ծրագրեր կամ անցանկալի բովանդակություն",
      responsibility5: "Չխախտել հեղինակային իրավունքներն ու մտավոր սեփականությունը",
      privacy: "4. Գաղտնիություն",
      privacyText: "Մենք հարգում ենք ձեր գաղտնիությունը: Բոլոր հաղորդագրությունները գաղտնագրվում են անվտանգության համար: Մենք չենք փոխանցում ձեր անձնական տվյալները երրորդ կողմերին առանց ձեր համաձայնության, բացառությամբ օրենքով նախատեսված դեպքերի:",
      dataStorage: "5. Տվյալների պահպանում",
      dataStorageText: "Ձեր հաղորդագրությունները և պրոֆիլի տվյալները պահվում են պաշտպանված սերվերներում: Մենք իրականացնում ենք բավարար միջոցառումներ ձեր տվյալները չարտոնված մուտքից պաշտպանելու համար, բայց չենք կարող երաշխավորել բացարձակ անվտանգություն:",
      prohibitedContent: "6. Արգելված բովանդակություն",
      prohibitedContentText: "Արգելվում է հետևյալ բովանդակությունը՝",
      prohibited1: "Սպառնալիքներ, վիրավորանքներ կամ ճնշումներ պարունակող նյութեր",
      prohibited2: "Պոռնոգրաֆիկ կամ անպատշաճ նյութեր",
      prohibited3: "Հեղինակային իրավունքները խախտող բովանդակություն",
      prohibited4: "Տեղեկություններ, որոնք կարող են վնաս պատճառել այլ օգտատերերին",
      termination: "7. Ծառայության դադարում",
      terminationText: "Մենք պահպանում ենք իրավունքը կասեցնելու կամ դադարեցնելու ձեր մուտքը ծառայություն այս օգտագործման պայմանների խախտման կամ այլ հիմնավոր պատճառների դեպքում:",
      limitation: "8. Պատասխանատվության սահմանափակում",
      limitationText: "DuoTalk-ը տրամադրվում է «ինչպես կա» սկզբունքով: Մենք պատասխանատվություն չենք կրում մեր ծառայության օգտագործման արդյունքում առաջացած որևէ վնասի համար, ներառյալ տվյալների կորուստը կամ ծառայության ընդհատումը:",
      changes: "9. Պայմանների փոփոխություններ",
      changesText: "Մենք կարող ենք ցանկացած ժամանակ փոփոխել այս օգտագործման պայմանները: Փոփոխություններից հետո ծառայության շարունակ օգտագործումը նշանակում է ձեր համաձայնությունը նոր պայմանների հետ:",
      contact: "10. Կապի տեղեկություններ",
      contactText: "Եթե ունեք հարցեր այս օգտագործման պայմանների վերաբերյալ, կարող եք կապվել մեզ հետ հավելվածի միջոցով:",
      languageChanged: "Լեզուն փոխվեց",
      languageDetected: "Հայտնաբերված լեզու",
      emailRequired: "Մուտքագրեք էլ. փոստը",
      passwordRequired: "Մուտքագրեք գաղտնաբառը",
      nameRequired: "Մուտքագրեք անունը",
      passwordsNoMatch: "Գաղտնաբառերը չեն համընկնում",
      agreeTermsRequired: "Պետք է համաձայնվել պայմանների հետ",
      registrationSuccess: "Գրանցումը հաջողվեց!",
      loginSuccess: "Մուտքը կատարվեց!",
      invalidCredentials: "Սխալ մուտքի տվյալներ",
      emailExists: "Այս էլ. փոստով օգտատեր արդեն գոյություն ունի"
    },
    fr: {
      chats: "Discussions", settings: "Paramètres", profile: "Profil", chat: "Chat",
      notifications: "Notifications", security: "Sécurité", yourName: "Votre nom",
      status: "Statut", interfaceLanguage: "Langue d'interface", room: "Salon",
      general: "💬 Chat général", private: "🔒 Chat privé", logout: "Déconnexion",
      saveChanges: "Enregistrer", settingsSaved: "Paramètres enregistrés avec succès", messageInput: "Message", send: "Envoyer",
      settingsDescription: "Personnalisez votre chat pour une communication confortable",
      enterName: "Entrez le nom", attachImage: "Joindre une image",
      attachFile: "Joindre un fichier", voiceMessage: "Message vocal",
      noChatsYet: "Pas encore de chats", close: "Fermer", darkMode: "Sombre",
      lightMode: "Clair", autoMode: "Auto", theme: "Thème",
      online: "🟢 En ligne", away: "🌙 Absent", busy: "⛔ Ne pas déranger", 
      invisible: "👻 Invisible", games: "🎮 Jeux", music: "🎵 Musique",
      nameDescription: "Ce nom sera visible par les autres utilisateurs",
      roomDescription: "Choisissez un salon pour communiquer",
      showTypingStatus: "Afficher le statut de frappe",
      enableNotifications: "Activer les notifications",
      notificationsDescription: "Recevoir des notifications pour les nouveaux messages",
      soundNotifications: "Notifications sonores",
      messageEncryption: "Chiffrement des messages",
      encryptionDescription: "Tous les messages seront chiffrés",
      privateMode: "Mode privé",
      privateModeDescription: "Masquer l'historique du chat à la sortie",
      translate: "Traduire",
      quickTranslate: "Traduction rapide",
      translateBeforeSend: "Traduire avant d'envoyer",
      originalText: "Texte original",
      translatedText: "Texte traduit",
      sourceLanguage: "Langue source",
      targetLanguage: "Langue cible",
      autoDetect: "🔍 Détection automatique",
      detectedLanguage: "Langue détectée:",
      sent: "envoyé",
      status: "Statut",
      read: "Lu",
      people: "pers.",
      today: "Aujourd'hui",
      yesterday: "Hier",
      isTyping: "écrit...",
      // Authentication
      login: "Connexion",
      register: "S'inscrire",
      welcomeBack: "Bienvenue !",
      loginDescription: "Connectez-vous à votre compte",
      createAccount: "Créer un compte",
      registerDescription: "Remplissez les détails pour vous inscrire",
      email: "Email",
      password: "Mot de passe",
      fullName: "Nom complet",
      confirmPassword: "Confirmer le mot de passe",
      passwordHint: "Minimum 6 caractères",
      signIn: "Se connecter",
      agreeTerms: "J'accepte les",
      termsOfService: "conditions d'utilisation",
      forgotPassword: "Mot de passe oublié ?",
      // Terms of Service
      termsOfServiceTitle: "Conditions d'utilisation DuoTalk",
      acceptAndClose: "Accepter et fermer",
      lastUpdated: "Dernière mise à jour:",
      lastUpdatedDate: "15 décembre 2024",
      acceptance: "1. Acceptation des conditions",
      acceptanceText: "En utilisant DuoTalk, vous acceptez ces conditions d'utilisation. Si vous n'acceptez pas ces conditions, veuillez ne pas utiliser notre service.",
      serviceDescription: "2. Description du service",
      serviceDescriptionText: "DuoTalk est une plateforme de messagerie instantanée qui permet aux utilisateurs de communiquer en temps réel. Le service comprend les messages texte, le partage de fichiers et d'images.",
      userResponsibilities: "3. Responsabilités des utilisateurs",
      userResponsibilitiesText: "Les utilisateurs s'engagent à :",
      responsibility1: "Fournir des informations exactes et à jour lors de l'inscription",
      responsibility2: "Ne pas utiliser le service pour des activités illégales",
      responsibility3: "Respecter les droits des autres utilisateurs",
      responsibility4: "Ne pas distribuer de spam, logiciels malveillants ou contenu indésirable",
      responsibility5: "Ne pas violer les droits d'auteur et la propriété intellectuelle",
      privacy: "4. Confidentialité",
      privacyText: "Nous respectons votre confidentialité. Tous les messages sont chiffrés pour la sécurité. Nous ne partageons pas vos données personnelles avec des tiers sans votre consentement, sauf dans les cas prévus par la loi.",
      dataStorage: "5. Stockage des données",
      dataStorageText: "Vos messages et données de profil sont stockés sur des serveurs sécurisés. Nous prenons des mesures raisonnables pour protéger vos données contre tout accès non autorisé, mais ne pouvons garantir une sécurité absolue.",
      prohibitedContent: "6. Contenu interdit",
      prohibitedContentText: "Le contenu suivant est interdit :",
      prohibited1: "Matériel contenant des menaces, insultes ou harcèlement",
      prohibited2: "Matériel pornographique ou inapproprié",
      prohibited3: "Contenu violant les droits d'auteur",
      prohibited4: "Informations pouvant nuire à d'autres utilisateurs",
      termination: "7. Résiliation du service",
      terminationText: "Nous nous réservons le droit de suspendre ou de résilier votre accès au service en cas de violation de ces conditions d'utilisation ou pour d'autres raisons valables.",
      limitation: "8. Limitation de responsabilité",
      limitationText: "DuoTalk est fourni \"en l'état\". Nous ne sommes pas responsables de tout dommage résultant de l'utilisation de notre service, y compris la perte de données ou l'interruption du service.",
      changes: "9. Modifications des conditions",
      changesText: "Nous pouvons modifier ces conditions d'utilisation à tout moment. L'utilisation continue du service après les modifications signifie votre accord avec les nouvelles conditions.",
      contact: "10. Informations de contact",
      contactText: "Si vous avez des questions concernant ces conditions d'utilisation, vous pouvez nous contacter via l'interface de l'application.",
      languageChanged: "Langue changée",
      languageDetected: "Langue détectée",
      emailRequired: "Veuillez saisir l'email",
      passwordRequired: "Veuillez saisir le mot de passe",
      nameRequired: "Veuillez saisir le nom",
      passwordsNoMatch: "Les mots de passe ne correspondent pas",
      agreeTermsRequired: "Vous devez accepter les conditions",
      registrationSuccess: "Inscription réussie !",
      loginSuccess: "Connexion réussie !",
      invalidCredentials: "Identifiants de connexion invalides",
      emailExists: "Un utilisateur avec cet email existe déjà"
    },
    de: {
      chats: "Chats", settings: "Einstellungen", profile: "Profil", chat: "Chat",
      notifications: "Benachrichtigungen", security: "Sicherheit", yourName: "Ihr Name",
      status: "Status", interfaceLanguage: "Interface-Sprache", room: "Raum",
      general: "💬 Allgemeiner Chat", private: "🔒 Privater Chat", logout: "Abmelden",
      saveChanges: "Speichern", settingsSaved: "Einstellungen erfolgreich gespeichert", messageInput: "Nachricht", send: "Senden",
      settingsDescription: "Passen Sie Ihren Chat für komfortable Kommunikation an",
      enterName: "Namen eingeben", attachImage: "Bild anhängen",
      attachFile: "Datei anhängen", voiceMessage: "Sprachnachricht",
      noChatsYet: "Noch keine Chats", close: "Schließen", darkMode: "Dunkel",
      lightMode: "Hell", autoMode: "Auto", theme: "Design",
      online: "🟢 Online", away: "🌙 Abwesend", busy: "⛔ Nicht stören", 
      invisible: "👻 Unsichtbar", games: "🎮 Spiele", music: "🎵 Musik",
      nameDescription: "Dieser Name wird anderen Benutzern angezeigt",
      roomDescription: "Wählen Sie einen Raum für die Kommunikation",
      showTypingStatus: "Tippstatus anzeigen",
      enableNotifications: "Benachrichtigungen aktivieren",
      notificationsDescription: "Benachrichtigungen für neue Nachrichten erhalten",
      soundNotifications: "Ton-Benachrichtigungen",
      messageEncryption: "Nachrichtenverschlüsselung",
      encryptionDescription: "Alle Nachrichten werden verschlüsselt",
      privateMode: "Privater Modus",
      privateModeDescription: "Chat-Verlauf beim Beenden ausblenden",
      translate: "Übersetzen",
      quickTranslate: "Schnell übersetzen",
      translateBeforeSend: "Vor dem Senden übersetzen",
      originalText: "Originaltext",
      translatedText: "Übersetzter Text",
      sourceLanguage: "Quellsprache",
      targetLanguage: "Zielsprache",
      autoDetect: "🔍 Automatische Erkennung",
      detectedLanguage: "Erkannte Sprache:",
      sent: "gesendet",
      status: "Status",
      read: "Gelesen",
      people: "Pers.",
      today: "Heute",
      yesterday: "Gestern",
      isTyping: "schreibt...",
      // Authentication
      login: "Anmelden",
      register: "Registrieren",
      welcomeBack: "Willkommen zurück!",
      loginDescription: "Melden Sie sich bei Ihrem Konto an",
      createAccount: "Konto erstellen",
      registerDescription: "Füllen Sie die Details zur Registrierung aus",
      email: "Email",
      password: "Passwort",
      fullName: "Vollständiger Name",
      confirmPassword: "Passwort bestätigen",
      passwordHint: "Mindestens 6 Zeichen",
      signIn: "Anmelden",
      agreeTerms: "Ich stimme den",
      termsOfService: "Nutzungsbedingungen zu",
      forgotPassword: "Passwort vergessen?",
      // Terms of Service
      termsOfServiceTitle: "DuoTalk Nutzungsbedingungen",
      acceptAndClose: "Akzeptieren und schließen",
      lastUpdated: "Zuletzt aktualisiert:",
      lastUpdatedDate: "15. Dezember 2024",
      acceptance: "1. Annahme der Bedingungen",
      acceptanceText: "Durch die Nutzung von DuoTalk stimmen Sie diesen Nutzungsbedingungen zu. Wenn Sie diesen Bedingungen nicht zustimmen, nutzen Sie bitte unseren Service nicht.",
      serviceDescription: "2. Service-Beschreibung",
      serviceDescriptionText: "DuoTalk ist eine Instant-Messaging-Plattform, die es Nutzern ermöglicht, in Echtzeit zu kommunizieren. Der Service umfasst Textnachrichten, Datei- und Bildaustausch.",
      userResponsibilities: "3. Nutzerpflichten",
      userResponsibilitiesText: "Nutzer verpflichten sich:",
      responsibility1: "Bei der Registrierung genaue und aktuelle Informationen anzugeben",
      responsibility2: "Den Service nicht für illegale Aktivitäten zu nutzen",
      responsibility3: "Die Rechte anderer Nutzer zu respektieren",
      responsibility4: "Keine Spam, Malware oder unerwünschte Inhalte zu verbreiten",
      responsibility5: "Keine Urheberrechte und geistiges Eigentum zu verletzen",
      privacy: "4. Datenschutz",
      privacyText: "Wir respektieren Ihre Privatsphäre. Alle Nachrichten werden zur Sicherheit verschlüsselt. Wir geben Ihre persönlichen Daten nicht ohne Ihre Zustimmung an Dritte weiter, außer in gesetzlich vorgeschriebenen Fällen.",
      dataStorage: "5. Datenspeicherung",
      dataStorageText: "Ihre Nachrichten und Profildaten werden auf sicheren Servern gespeichert. Wir ergreifen angemessene Maßnahmen zum Schutz Ihrer Daten vor unbefugtem Zugriff, können aber keine absolute Sicherheit garantieren.",
      prohibitedContent: "6. Verbotene Inhalte",
      prohibitedContentText: "Folgende Inhalte sind verboten:",
      prohibited1: "Material mit Bedrohungen, Beleidigungen oder Belästigung",
      prohibited2: "Pornographisches oder unangemessenes Material",
      prohibited3: "Inhalte, die Urheberrechte verletzen",
      prohibited4: "Informationen, die anderen Nutzern schaden können",
      termination: "7. Service-Beendigung",
      terminationText: "Wir behalten uns das Recht vor, Ihren Zugang zum Service bei Verletzung dieser Nutzungsbedingungen oder aus anderen berechtigten Gründen zu sperren oder zu beenden.",
      limitation: "8. Haftungsbeschränkung",
      limitationText: "DuoTalk wird \"wie besehen\" bereitgestellt. Wir sind nicht verantwortlich für Schäden, die durch die Nutzung unseres Services entstehen, einschließlich Datenverlust oder Service-Unterbrechungen.",
      changes: "9. Änderungen der Bedingungen",
      changesText: "Wir können diese Nutzungsbedingungen jederzeit ändern. Die fortgesetzte Nutzung des Services nach Änderungen bedeutet Ihre Zustimmung zu den neuen Bedingungen.",
      contact: "10. Kontaktinformationen",
      contactText: "Wenn Sie Fragen zu diesen Nutzungsbedingungen haben, können Sie uns über die Anwendungsoberfläche kontaktieren.",
      languageChanged: "Sprache geändert",
      languageDetected: "Sprache erkannt",
      emailRequired: "Bitte geben Sie die Email ein",
      passwordRequired: "Bitte geben Sie das Passwort ein",
      nameRequired: "Bitte geben Sie den Namen ein",
      passwordsNoMatch: "Passwörter stimmen nicht überein",
      agreeTermsRequired: "Sie müssen den Bedingungen zustimmen",
      registrationSuccess: "Registrierung erfolgreich!",
      loginSuccess: "Anmeldung erfolgreich!",
      invalidCredentials: "Ungültige Anmeldedaten",
      emailExists: "Benutzer mit dieser Email existiert bereits"
    },
    es: {
      chats: "Chats", settings: "Configuración", profile: "Perfil", chat: "Chat",
      notifications: "Notificaciones", security: "Seguridad", yourName: "Su nombre",
      status: "Estado", interfaceLanguage: "Idioma de interfaz", room: "Sala",
      general: "💬 Chat general", private: "🔒 Chat privado", logout: "Cerrar sesión",
      saveChanges: "Guardar", settingsSaved: "Configuración guardada exitosamente", messageInput: "Mensaje", send: "Enviar",
      settingsDescription: "Personalice su chat para una comunicación cómoda",
      enterName: "Ingrese el nombre", attachImage: "Adjuntar imagen",
      attachFile: "Adjuntar archivo", voiceMessage: "Mensaje de voz",
      noChatsYet: "Aún no hay chats", close: "Cerrar", darkMode: "Oscuro",
      lightMode: "Claro", autoMode: "Auto", theme: "Tema",
      online: "🟢 En línea", away: "🌙 Ausente", busy: "⛔ No molestar", 
      invisible: "👻 Invisible", games: "🎮 Juegos", music: "🎵 Música",
      nameDescription: "Este nombre será visible para otros usuarios",
      roomDescription: "Elija una sala para comunicarse",
      showTypingStatus: "Mostrar estado de escritura",
      enableNotifications: "Habilitar notificaciones",
      notificationsDescription: "Recibir notificaciones sobre nuevos mensajes",
      soundNotifications: "Notificaciones de sonido",
      messageEncryption: "Cifrado de mensajes",
      encryptionDescription: "Todos los mensajes serán cifrados",
      privateMode: "Modo privado",
      privateModeDescription: "Ocultar historial de chat al salir",
      translate: "Traducir",
      quickTranslate: "Traducir rápido",
      translateBeforeSend: "Traducir antes de enviar",
      originalText: "Texto original",
      translatedText: "Texto traducido",
      sourceLanguage: "Idioma origen",
      targetLanguage: "Idioma destino",
      autoDetect: "🔍 Detección automática",
      detectedLanguage: "Idioma detectado:",
      sent: "enviado",
      status: "Estado",
      read: "Leído",
      people: "pers.",
      today: "Hoy",
      yesterday: "Ayer",
      isTyping: "escribiendo...",
      // Authentication
      login: "Iniciar sesión",
      register: "Registrarse",
      welcomeBack: "¡Bienvenido de vuelta!",
      loginDescription: "Inicie sesión en su cuenta",
      createAccount: "Crear cuenta",
      registerDescription: "Complete los detalles para registrarse",
      email: "Email",
      password: "Contraseña",
      fullName: "Nombre completo",
      confirmPassword: "Confirmar contraseña",
      passwordHint: "Mínimo 6 caracteres",
      signIn: "Iniciar sesión",
      agreeTerms: "Acepto los",
      termsOfService: "términos de uso",
      forgotPassword: "¿Olvidó la contraseña?",
      // Terms of Service
      termsOfServiceTitle: "Términos de uso DuoTalk",
      acceptAndClose: "Aceptar y cerrar",
      lastUpdated: "Última actualización:",
      lastUpdatedDate: "15 de diciembre de 2024",
      acceptance: "1. Aceptación de términos",
      acceptanceText: "Al usar DuoTalk, usted acepta estos términos de uso. Si no está de acuerdo con alguno de estos términos, por favor no use nuestro servicio.",
      serviceDescription: "2. Descripción del servicio",
      serviceDescriptionText: "DuoTalk es una plataforma de mensajería instantánea que permite a los usuarios comunicarse en tiempo real. El servicio incluye mensajes de texto, intercambio de archivos e imágenes.",
      userResponsibilities: "3. Responsabilidades del usuario",
      userResponsibilitiesText: "Los usuarios se comprometen a:",
      responsibility1: "Proporcionar información precisa y actualizada durante el registro",
      responsibility2: "No usar el servicio para actividades ilegales",
      responsibility3: "Respetar los derechos de otros usuarios",
      responsibility4: "No distribuir spam, malware o contenido no deseado",
      responsibility5: "No violar derechos de autor y propiedad intelectual",
      privacy: "4. Privacidad",
      privacyText: "Respetamos su privacidad. Todos los mensajes están cifrados por seguridad. No compartimos sus datos personales con terceros sin su consentimiento, excepto en casos requeridos por ley.",
      dataStorage: "5. Almacenamiento de datos",
      dataStorageText: "Sus mensajes y datos de perfil se almacenan en servidores seguros. Tomamos medidas razonables para proteger sus datos del acceso no autorizado, pero no podemos garantizar seguridad absoluta.",
      prohibitedContent: "6. Contenido prohibido",
      prohibitedContentText: "El siguiente contenido está prohibido:",
      prohibited1: "Material que contenga amenazas, insultos o acoso",
      prohibited2: "Material pornográfico o inapropiado",
      prohibited3: "Contenido que viole derechos de autor",
      prohibited4: "Información que pueda dañar a otros usuarios",
      termination: "7. Terminación del servicio",
      terminationText: "Nos reservamos el derecho de suspender o terminar su acceso al servicio en caso de violación de estos términos de uso u otras razones justificadas.",
      limitation: "8. Limitación de responsabilidad",
      limitationText: "DuoTalk se proporciona \"tal como está\". No somos responsables de ningún daño resultante del uso de nuestro servicio, incluyendo pérdida de datos o interrupción del servicio.",
      changes: "9. Cambios en los términos",
      changesText: "Podemos cambiar estos términos de uso en cualquier momento. El uso continuado del servicio después de los cambios significa su acuerdo con los nuevos términos.",
      contact: "10. Información de contacto",
      contactText: "Si tiene preguntas sobre estos términos de uso, puede contactarnos a través de la interfaz de la aplicación.",
      languageChanged: "Idioma cambiado",
      languageDetected: "Idioma detectado",
      emailRequired: "Por favor ingrese el email",
      passwordRequired: "Por favor ingrese la contraseña",
      nameRequired: "Por favor ingrese el nombre",
      passwordsNoMatch: "Las contraseñas no coinciden",
      agreeTermsRequired: "Debe aceptar los términos",
      registrationSuccess: "¡Registro exitoso!",
      loginSuccess: "¡Inicio de sesión exitoso!",
      invalidCredentials: "Credenciales de inicio de sesión inválidas",
      emailExists: "Ya existe un usuario con este email"
    }
  };



  // Function to update UI text based on selected language
  function updateUILanguage(lang) {
    const t = translations[lang];
    if (!t) return;

    // Add smooth transition effect
    const elements = document.querySelectorAll('[data-translate]');
    elements.forEach(el => {
      el.style.transition = 'opacity 0.2s ease';
      el.style.opacity = '0.7';
    });

    // Update all translatable elements
    document.querySelectorAll('[data-translate]').forEach(el => {
      const key = el.dataset.translate;
      if (t[key]) {
        el.textContent = t[key];
      }
    });

    // Update nav tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
      const key = tab.dataset.translate;
      if (t[key]) {
        tab.textContent = t[key];
      }
    });

    // Update placeholders
    const messageInput = document.getElementById('messageInput');
    if (messageInput && t.messageInput) {
      messageInput.placeholder = t.messageInput;
    }
    
    // Update all elements with data-translate-placeholder
    document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
      const key = el.dataset.translatePlaceholder;
      if (t[key]) {
        el.placeholder = t[key];
      }
    });
    
    // Update all elements with data-translate-title
    document.querySelectorAll('[data-translate-title]').forEach(el => {
      const key = el.dataset.translateTitle;
      if (t[key]) {
        el.title = t[key];
        el.setAttribute('aria-label', t[key]);
      }
    });

    // Update option texts
    document.querySelectorAll('option[data-translate]').forEach(option => {
      const key = option.dataset.translate;
      if (t[key]) {
        option.textContent = t[key];
      }
    });

    // Update existing translate buttons
    document.querySelectorAll('.translate-btn').forEach(btn => {
      btn.title = t.translate || 'Translate';
    });

    // Update settings language selector to show current language
    const languageSelector = document.getElementById('settingsLanguage');
    if (languageSelector) {
      languageSelector.value = lang;
    }

    // Restore opacity after a short delay
    setTimeout(() => {
      elements.forEach(el => {
        el.style.opacity = '1';
      });
    }, 200);

    // Save language preference
    localStorage.setItem('language', lang);
    currentLanguage = lang;
  }

  // Message translation system (like Telegram)
  let translateEnabled = true;
  let translateTargetLanguage = 'en';
  
  // Function to translate a single message
  async function translateMessage(messageElement, originalText) {
    // Remove any existing translation
    const existingTranslation = messageElement.querySelector('.message-translation');
    if (existingTranslation) {
      existingTranslation.remove();
      return;
    }
    
    // Show loading indicator
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'message-translation';
    const t = translations[currentLanguage] || translations.en;
    const loadingText = {
      ru: 'Переводится...',
      en: 'Translating...',
      am: 'Թարգմանվում է...',
      fr: 'Traduction...',
      de: 'Übersetzen...',
      es: 'Traduciendo...'
    };
    loadingDiv.innerHTML = `
      <div class="translation-text">${loadingText[currentLanguage] || loadingText.en}</div>
      <button class="translation-close" onclick="hideTranslation(this)">×</button>
    `;
    messageElement.appendChild(loadingDiv);
    
    try {
      // Try multiple translation services
      let translatedText = null;
      
      // Method 1: MyMemory API (free, no API key needed)
      try {
        const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(originalText)}&langpair=autodetect|${currentLanguage}`);
        const data = await response.json();
        if (data && data.responseData && data.responseData.translatedText) {
          translatedText = data.responseData.translatedText;
        }
      } catch (e) {
        console.warn('MyMemory API failed:', e);
      }
      
      // Method 2: LibreTranslate API (fallback)
      if (!translatedText) {
        try {
          const response = await fetch('https://libretranslate.de/translate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              q: originalText,
              source: 'auto',
              target: currentLanguage,
              format: 'text'
            })
          });
          const data = await response.json();
          if (data && data.translatedText) {
            translatedText = data.translatedText;
          }
        } catch (e) {
          console.warn('LibreTranslate API failed:', e);
        }
      }
      
      // Method 3: Simple Google Translate (fallback)
      if (!translatedText) {
        try {
          const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${currentLanguage}&dt=t&q=${encodeURIComponent(originalText)}`);
          const data = await response.json();
          if (data && data[0] && data[0][0] && data[0][0][0]) {
            translatedText = data[0][0][0];
          }
        } catch (e) {
          console.warn('Google Translate failed:', e);
        }
      }
      
      // Update the translation display
      if (translatedText && translatedText !== originalText) {
        loadingDiv.querySelector('.translation-text').textContent = translatedText;
      } else {
        const noTranslationText = {
          ru: 'Перевод недоступен',
          en: 'Translation unavailable',
          am: 'Թարգմանությունը հասանելի չէ',
          fr: 'Traduction indisponible',
          de: 'Übersetzung nicht verfügbar',
          es: 'Traducción no disponible'
        };
        loadingDiv.querySelector('.translation-text').textContent = noTranslationText[currentLanguage] || noTranslationText.en;
      }
      
      // Add animation
      loadingDiv.style.opacity = '0';
      loadingDiv.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        loadingDiv.style.opacity = '1';
        loadingDiv.style.transform = 'translateY(0)';
        loadingDiv.style.transition = 'all 0.2s ease';
      }, 10);
      
    } catch (error) {
      console.warn('Translation failed:', error);
      const errorText = {
        ru: 'Ошибка перевода',
        en: 'Translation error',
        am: 'Թարգմանության սխալ',
        fr: 'Erreur de traduction',
        de: 'Übersetzungsfehler',
        es: 'Error de traducción'
      };
      loadingDiv.querySelector('.translation-text').textContent = errorText[currentLanguage] || errorText.en;
    }
  }
  
  // Function to hide translation
  function hideTranslation(closeBtn) {
    const translationDiv = closeBtn.parentElement;
    translationDiv.style.opacity = '0';
    translationDiv.style.transform = 'translateY(-10px)';
    setTimeout(() => {
      translationDiv.remove();
    }, 200);
  }
  
  // Function to add translate button to message
  function addTranslateButton(messageElement, messageText) {
    // Don't add translate button if text is too short
    if (messageText.length < 3) return;
    
    // Check if message contains non-Latin characters (might need translation)
    const hasNonLatin = /[^\x00-\x7F]/.test(messageText);
    const hasLatin = /[a-zA-Z]/.test(messageText);
    
    // Language detection patterns
    const isRussian = /[а-яё]/i.test(messageText);
    const isArmenian = /[Ա-Ֆա-ֆ]/.test(messageText);
    const isFrench = /[àâäéèêëïîôöùûüÿç]/i.test(messageText);
    const isGerman = /[äöüß]/i.test(messageText);
    const isSpanish = /[ñáéíóúü]/i.test(messageText);
    
    // Don't show translate button if message is likely in current UI language
    const isCurrentLanguage = 
      (currentLanguage === 'ru' && isRussian) ||
      (currentLanguage === 'en' && hasLatin && !hasNonLatin) ||
      (currentLanguage === 'am' && isArmenian) ||
      (currentLanguage === 'fr' && isFrench) ||
      (currentLanguage === 'de' && isGerman) ||
      (currentLanguage === 'es' && isSpanish);
    
    // Show translate button if message is likely in a different language
    if (!isCurrentLanguage && (hasNonLatin || hasLatin)) {
      const translateBtn = document.createElement('button');
      translateBtn.className = 'translate-btn';
      translateBtn.innerHTML = '🌐';
      translateBtn.title = translations[currentLanguage]?.translate || 'Translate';
      translateBtn.onclick = (e) => {
        e.stopPropagation();
        translateMessage(messageElement, messageText);
      };
      
      // Add to message with a small delay for better UX
      setTimeout(() => {
        messageElement.appendChild(translateBtn);
      }, 100);
    }
  }
  function saveSettings() {
    // Анимация кнопки сохранения
    const saveBtn = document.getElementById('settingsSaveBtn');
    saveBtn.style.transform = 'scale(0.95)';
    setTimeout(() => saveBtn.style.transform = 'translateY(-2px)', 100);

    // Save and apply language settings
    const lang = document.getElementById('settingsLanguage').value;
    localStorage.setItem('language', lang);
    currentLanguage = lang;
    
    // Update UI with new language immediately
      updateUILanguage(lang);
      


    // Сохраняем имя пользователя
    const name = document.getElementById('settingsName').value.trim();
    if (name) {
      document.getElementById('nameInput').value = name;
      localStorage.chatName = name;
    }
    
    // Сохраняем статус
    const status = document.getElementById('settingsStatus').value;
    localStorage.userStatus = status;
    
    // Обработка смены комнаты
    const newRoom = document.getElementById('settingsRoom').value;
    if (newRoom !== room) {
      room = newRoom;
      loadRoom();
    }
    
    // Сохраняем настройки уведомлений
    const notifications = {
      enabled: document.getElementById('settingsNotifications').checked,
      sound: document.getElementById('settingsSound').checked,
      typing: document.getElementById('settingsTyping').checked
    };
    localStorage.notifications = JSON.stringify(notifications);

    // Сохраняем настройки безопасности
    localStorage.encryption = document.getElementById('settingsEncryption').checked;
    localStorage.privateMode = document.getElementById('settingsPrivateMode').checked;
    
    // Применяем настройки
    if (notifications.enabled && Notification.permission !== "granted") {
      Notification.requestPermission();
    }
    
    // Создаем уведомление о сохранении
    const toast = document.createElement('div');
    toast.style.position = 'fixed';
    toast.style.bottom = '24px';
    toast.style.left = '50%';
    toast.style.transform = 'translateX(-50%) translateY(100px)';
    toast.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
    toast.style.color = '#fff';
    toast.style.padding = '16px 32px';
    toast.style.borderRadius = '12px';
    toast.style.fontSize = '15px';
    toast.style.fontWeight = '600';
    toast.style.boxShadow = '0 4px 12px rgba(76,175,80,0.3)';
    toast.style.zIndex = '1000';
    toast.style.display = 'flex';
    toast.style.alignItems = 'center';
    toast.style.gap = '8px';
    toast.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
    
    // Добавляем иконку успеха
    const t = translations[currentLanguage] || translations.en;
    toast.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
      ${t.settingsSaved || 'Settings saved successfully'}
    `;
    
    document.body.appendChild(toast);
    
    // Анимируем появление
    setTimeout(() => {
      toast.style.transform = 'translateX(-50%) translateY(0)';
    }, 100);
    
    // Удаляем уведомление через 3 секунды
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transition = 'opacity 0.3s ease';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
    
    // Возвращаемся в чат
    switchView('chats');
    document.querySelector('.nav-tab').classList.add('active');
  }

  // Authentication Functions
  function showAuthModal() {
    const modal = document.getElementById('authModalBackdrop');
    modal.classList.add('show');
    initializeLanguageButtons();
    
    // Force update translations for agreement text
    setTimeout(() => {
      const t = translations[currentLanguage] || translations.en;
      const agreeSpan = document.querySelector('[data-translate="agreeTerms"]');
      const termsLink = document.querySelector('[data-translate="termsOfService"]');
      
      if (agreeSpan && t.agreeTerms) {
        agreeSpan.textContent = t.agreeTerms;
      }
      if (termsLink && t.termsOfService) {
        termsLink.textContent = t.termsOfService;
      }
    }, 100);
  }
  
  function hideAuthModal() {
    const modal = document.getElementById('authModalBackdrop');
    modal.classList.remove('show');
  }
  
  function switchAuthTab(tab) {
    const loginTab = document.getElementById('loginTab');
    const registerTab = document.getElementById('registerTab');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    
    if (tab === 'login') {
      loginTab.classList.add('active');
      registerTab.classList.remove('active');
      loginForm.style.display = 'block';
      registerForm.style.display = 'none';
    } else {
      registerTab.classList.add('active');
      loginTab.classList.remove('active');
      registerForm.style.display = 'block';
      loginForm.style.display = 'none';
    }
  }
  
  function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }
  
  function hashPassword(password) {
    // Simple hash function (in production, use proper password hashing)
    return CryptoJS.SHA256(password).toString();
  }
  
  async function handleRegister() {
    const t = translations[currentLanguage] || translations.en;
    const name = document.getElementById('registerName').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('registerConfirmPassword').value;
    const agreeTerms = document.getElementById('agreeTerms').checked;
    
    // Validation
    if (!name) {
      showToast(t.nameRequired, 'error');
      return;
    }
    
    if (!email) {
      showToast(t.emailRequired, 'error');
      return;
    }
    
    if (!validateEmail(email)) {
      showToast('Invalid email format', 'error');
      return;
    }
    
    if (!password) {
      showToast(t.passwordRequired, 'error');
      return;
    }
    
    if (password.length < 6) {
      showToast(t.passwordHint, 'error');
      return;
    }
    
    if (password !== confirmPassword) {
      showToast(t.passwordsNoMatch, 'error');
      return;
    }
    
    if (!agreeTerms) {
      showToast(t.agreeTermsRequired, 'error');
      return;
    }
    
    const registerBtn = document.getElementById('registerBtn');
    registerBtn.disabled = true;
    registerBtn.innerHTML = '<span>Регистрация...</span>';
    
    try {
      // Check if user already exists
      const userCheck = await db.ref(`users/${encodeBase64Unicode(email)}`).once('value');
      if (userCheck.exists()) {
        showToast(t.emailExists, 'error');
        return;
      }
      
      // Create user account
      const userId = encodeBase64Unicode(email);
      const hashedPassword = hashPassword(password);
      const userData = {
        name: name,
        email: email,
        password: hashedPassword,
        createdAt: Date.now(),
        lastLogin: Date.now(),
        status: 'online',
        avatar: name.charAt(0).toUpperCase()
      };
      
      await db.ref(`users/${userId}`).set(userData);
      
      // Log user in
      currentUser = { id: userId, ...userData };
      isAuthenticated = true;
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      localStorage.setItem('userToken', userId);
      
      showToast(t.registrationSuccess, 'success');
      hideAuthModal();
      initializeUserSession();
      
    } catch (error) {
      console.error('Registration error:', error);
      showToast('Registration failed. Please try again.', 'error');
    } finally {
      registerBtn.disabled = false;
      registerBtn.innerHTML = `<span data-translate="createAccount">${t.createAccount}</span>`;
    }
  }
  
  async function handleLogin() {
    const t = translations[currentLanguage] || translations.en;
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!email) {
      showToast(t.emailRequired, 'error');
      return;
    }
    
    if (!password) {
      showToast(t.passwordRequired, 'error');
      return;
    }
    
    const loginBtn = document.getElementById('loginBtn');
    loginBtn.disabled = true;
    loginBtn.innerHTML = '<span>Вход...</span>';
    
    try {
      const userId = encodeBase64Unicode(email);
      const userSnapshot = await db.ref(`users/${userId}`).once('value');
      
      if (!userSnapshot.exists()) {
        showToast(t.invalidCredentials, 'error');
        return;
      }
      
      const userData = userSnapshot.val();
      const hashedPassword = hashPassword(password);
      
      if (userData.password !== hashedPassword) {
        showToast(t.invalidCredentials, 'error');
        return;
      }
      
      // Update last login
      await db.ref(`users/${userId}/lastLogin`).set(Date.now());
      
      // Set current user
      currentUser = { id: userId, ...userData };
      isAuthenticated = true;
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      localStorage.setItem('userToken', userId);
      
      showToast(t.loginSuccess, 'success');
      hideAuthModal();
      initializeUserSession();
      
    } catch (error) {
      console.error('Login error:', error);
      showToast('Login failed. Please try again.', 'error');
    } finally {
      loginBtn.disabled = false;
      loginBtn.innerHTML = `<span data-translate="signIn">${t.signIn}</span>`;
    }
  }
  

  
  function initializeUserSession() {
    // Set user name in the input
    document.getElementById('nameInput').value = currentUser.name;
    localStorage.chatName = currentUser.name;
    
    // Update UI to show authenticated state
    updateSidebar();
    loadRoom();
  }
  
  function showForgotPassword() {
    showToast('Восстановление пароля временно недоступно', 'info');
  }

  // Terms of Service Functions
  function showTermsOfService() {
    const modal = document.getElementById('termsModalBackdrop');
    modal.classList.add('show');
  }
  
  function hideTermsOfService() {
    const modal = document.getElementById('termsModalBackdrop');
    modal.classList.remove('show');
  }
  
  function acceptTerms() {
    const agreeCheckbox = document.getElementById('agreeTerms');
    agreeCheckbox.checked = true;
    hideTermsOfService();
    showToast('Условия использования приняты', 'success');
  }

  // Language change function for auth modal
  function changeAuthLanguage(lang) {
    // Update global language
    currentLanguage = lang;
    localStorage.setItem('language', lang);
    
    // Update UI with new language
    updateUILanguage(lang);
    
    // Force update specific problematic elements
    const agreeSpan = document.querySelector('[data-translate="agreeTerms"]');
    const termsLink = document.querySelector('[data-translate="termsOfService"]');
    const t = translations[lang] || translations.en;
    
    if (agreeSpan && t.agreeTerms) {
      agreeSpan.textContent = t.agreeTerms;
    }
    if (termsLink && t.termsOfService) {
      termsLink.textContent = t.termsOfService;
    }
    
    // Update the select value
    const authLanguageSelect = document.getElementById('authLanguageSelect');
    if (authLanguageSelect) {
      authLanguageSelect.value = lang;
    }
    
    // Show toast notification
    showToast(t.languageChanged || 'Language changed', 'success');
  }

  // Initialize language selector
  function initializeLanguageButtons() {
    const authLanguageSelect = document.getElementById('authLanguageSelect');
    if (authLanguageSelect) {
      authLanguageSelect.value = currentLanguage;
    }
  }
  
  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.position = 'fixed';
    toast.style.bottom = '24px';
    toast.style.right = '24px';
    toast.style.maxWidth = '300px';
    toast.style.padding = '16px 20px';
    toast.style.borderRadius = '12px';
    toast.style.fontSize = '14px';
    toast.style.fontWeight = '500';
    toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
    toast.style.zIndex = '9999';
    toast.style.transform = 'translateX(100%)';
    toast.style.transition = 'transform 0.3s ease';
    
    // Set colors based on type
    switch(type) {
      case 'success':
        toast.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
        toast.style.color = '#fff';
        break;
      case 'error':
        toast.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
        toast.style.color = '#fff';
        break;
      case 'info':
      default:
        toast.style.background = 'linear-gradient(135deg, #6a5cff 0%, #4f8cff 100%)';
        toast.style.color = '#fff';
        break;
    }
    
    toast.textContent = message;
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
      toast.style.transform = 'translateX(0)';
    }, 100);
    
    // Remove after 4 seconds
    setTimeout(() => {
      toast.style.transform = 'translateX(100%)';
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }
  
  // Check for existing authentication on page load
  function checkExistingAuth() {
    const savedUser = localStorage.getItem('currentUser');
    const userToken = localStorage.getItem('userToken');
    
    if (savedUser && userToken) {
      try {
        currentUser = JSON.parse(savedUser);
        isAuthenticated = true;
        initializeUserSession();
        return true;
      } catch (error) {
        console.error('Error parsing saved user:', error);
        localStorage.removeItem('currentUser');
        localStorage.removeItem('userToken');
      }
    }
    
    return false;
  }

  function encodeBase64Unicode(str) {
    return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
      return String.fromCharCode(parseInt(p1, 16));
    }));
  }
  // Оптимизированная загрузка комнаты с виртуализацией
  let messagesCache = new Map();
  let visibilityObserver;

  function loadRoom(){
    const chatElement = document.getElementById("chat");
    chatElement.innerHTML = "";
    messagesCache.clear();
    let lastDate = 0;
    
    // Функция для удаления дублированных разделителей дат
    function removeDuplicateDateSeparators() {
      const separators = chatElement.querySelectorAll('.date-sep');
      const seenDates = new Set();
      
      separators.forEach((separator, index) => {
        const dateText = separator.getAttribute('data-date') || separator.innerText;
        if (seenDates.has(dateText)) {
          console.log(`Удаляем дублированный разделитель: "${dateText}"`);
          separator.remove();
        } else {
          seenDates.add(dateText);
        }
      });
      
      console.log(`Проверено разделителей: ${separators.length}, уникальных дат: ${seenDates.size}`);
    }
    
    // Делаем функцию доступной глобально для отладки
    window.removeDuplicateDateSeparators = removeDuplicateDateSeparators;
    
    // Отключаем старые слушатели
    if (window.db) {
      window.db.ref(`rooms/${room}/messages`).off();
      window.db.ref(`rooms/${room}/typing`).off();
    }
    
    // Intersection Observer для lazy loading изображений
    if(visibilityObserver) visibilityObserver.disconnect();
    visibilityObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target.querySelector('img[data-src]');
          if (img) {
            img.src = img.dataset.src;
            img.removeAttribute('data-src');
            visibilityObserver.unobserve(entry.target);
          }
        }
      });
    }, { threshold: 0.1 });
    
    // Оптимизированные слушатели с ограничением количества сообщений и пагинацией
    if (!window.db) return;
    const messagesRef = window.db.ref(`rooms/${room}/messages`).limitToLast(50);
    
    messagesRef.on("child_added", snap => {
      const m = snap.val(), k = snap.key;
      messagesCache.set(k, m);
      
      // Батчинг обновлений DOM
      requestAnimationFrame(() => {
      const currentDateText = sepText(m.time);
      if(!lastDate || currentDateText !== sepText(lastDate)){
        // Проверяем, нет ли уже такого разделителя
        const existingSeparator = chatElement.querySelector(`[data-date="${currentDateText}"]`);
        if (!existingSeparator) {
        const s = document.createElement("div");
        s.className = "date-sep";
          s.setAttribute('data-date', currentDateText);
          s.innerText = currentDateText;
          chatElement.appendChild(s);
        }
        lastDate = m.time;
      }
      renderMessage(m, k);
        
        // Оптимизированный скроллинг
        if (chatElement.scrollHeight - chatElement.scrollTop <= chatElement.clientHeight + 100) {
          chatElement.scrollTop = chatElement.scrollHeight;
        }
        
        // Периодически очищаем дублированные разделители
        setTimeout(() => {
          removeDuplicateDateSeparators();
          // Дополнительная очистка через 500мс для надежности
          setTimeout(removeDuplicateDateSeparators, 500);
        }, 100);
      });
    });
    
    // Дебаунсинг для typing индикатора
    let typingTimeout;
    window.db.ref(`rooms/${room}/typing`).on("value", snap => {
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        const typingElement = document.getElementById("typingStatus");
        if (typingElement) {
          typingElement.innerText = snap.val() || "";
        }
      }, 50);
    });
  }

  function renderMessage(m, id){
    const chat = document.getElementById("chat");
    const me = document.getElementById("nameInput").value.trim();
    const d = document.createElement("div");
    d.className = "msg " + (m.name === me ? "you" : "other");
    d.id = "msg-" + id;
    d.dataset.preview = window.dec ? window.dec(m.msg).substring(0, 30) : m.msg.substring(0, 30);

    const bubble = document.createElement("div"); 
    bubble.className = "bubble";
    
    if(m.replyId){
      const prev = document.getElementById("msg-" + m.replyId);
      if(prev){
        const q = document.createElement("div");
        q.className = "reply";
        q.innerText = prev.dataset.preview;
        bubble.appendChild(q);
      }
    }

    const text = window.dec(m.msg);
    const isImg = text.startsWith('<img') || text.startsWith('<video');
    bubble.innerHTML += isImg ? text : window.parse(text);
    
    const tspan = document.createElement("span");
    tspan.className = "msg-time";
    tspan.innerText = fmtTime(m.time);
    bubble.appendChild(tspan);

    if(m.reads){
      const rspan = document.createElement("span");
      rspan.className = "read";
      rspan.innerText = Object.keys(m.reads).length > 1 ? "✓✓" : "✓";
      bubble.appendChild(rspan);
    }

    // Кнопка удаления
    if(m.name === me){
      const delBtn = document.createElement("button");
      delBtn.className = "msg-del-btn";
      delBtn.title = "Удалить сообщение";
      delBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>`;
      delBtn.onclick = (e) => {
        e.stopPropagation();
        if(confirm("Удалить сообщение?") && window.db){
          window.db.ref(`rooms/${room}/messages/${id}`).remove();
        }
      };
      bubble.appendChild(delBtn);
    }

    // Кнопка информации
    const infoBtn = document.createElement("button");
    infoBtn.className = "msg-info-btn";
    infoBtn.title = "Информация о сообщении";
    infoBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="8"/></svg>`;
    infoBtn.onclick = (e) => {
      e.stopPropagation();
      showMsgInfo(m, id);
    };
    bubble.appendChild(infoBtn);

    // Кнопка перевода (только для сообщений других пользователей)
    if (m.name !== me && window.dec) {
      const text = window.dec(m.msg);
      // Проверяем, что это текстовое сообщение (не изображение/видео)
      if (!text.startsWith('<img') && !text.startsWith('<video')) {
        addTranslateButton(bubble, text);
      }
    }

    d.appendChild(bubble);
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;

    if(m.name !== me){
      const uid = encodeBase64Unicode(me);
      db.ref(`rooms/${room}/messages/${id}/reads/${uid}`).set(true);
    }
  }

  // Информация о сообщении рядом с сообщением
  function showMsgInfo(m, id) {
    // Скрываем все открытые панели информации
    document.querySelectorAll('.msg-info-panel').forEach(panel => {
      const messageElement = panel.closest('.msg');
      if (messageElement) {
        messageElement.classList.remove('has-info-panel');
      }
      panel.remove();
    });
    
    const messageElement = document.getElementById('msg-' + id);
    if (!messageElement) return;
    
    const messageText = window.dec ? window.dec(m.msg) : m.msg;
    const t = translations[currentLanguage] || translations.en;
    
    const infoPanel = document.createElement('div');
    infoPanel.className = 'msg-info-panel';
    infoPanel.innerHTML = `
      <div class="msg-info-content">
        <button class="msg-info-close" onclick="hideMsgInfo()">×</button>
        
        <div class="msg-info-body">
          ${m.reads ? `
            <div class="msg-info-item">
              <span class="msg-info-label">${t.read}</span>
              <span class="msg-info-value">${Object.keys(m.reads).length} ${t.people}</span>
            </div>
          ` : `
            <div class="msg-info-item">
              <span class="msg-info-label">${t.status}</span>
              <span class="msg-info-value">${t.sent}</span>
            </div>
          `}
        </div>
      </div>
    `;
    
    // Добавляем класс для overflow: visible
    messageElement.classList.add('has-info-panel');
    
    // Вставляем панель внутри контейнера сообщения
    messageElement.appendChild(infoPanel);
    
    // Анимация появления
    setTimeout(() => infoPanel.classList.add('show'), 10);
    
    // Скрываем при клике вне панели
    setTimeout(() => {
      document.addEventListener('click', function hideOnClickOutside(e) {
        if (!infoPanel.contains(e.target) && !e.target.closest('.msg-info-btn')) {
          hideMsgInfo();
          document.removeEventListener('click', hideOnClickOutside);
        }
      });
    }, 100);
  }
  
  function hideMsgInfo() {
    const panels = document.querySelectorAll('.msg-info-panel');
    panels.forEach(panel => {
      panel.classList.remove('show');
      const messageElement = panel.closest('.msg');
      if (messageElement) {
        messageElement.classList.remove('has-info-panel');
      }
      setTimeout(() => panel.remove(), 200);
    });
  }
  


  // Оптимизированная функция отправки сообщений
  function doSend(){
    const name = nameInput.value.trim();
    const msg = messageInput.value.trim();
    const now = Date.now();
    
    // Проверки валидности
    if(!name || (!msg && !replyTo) || now - lastSent < 800) return;
    
    // Создание payload с минимальными данными
    const payload = {name, msg: window.enc(msg), time: now};
    if(replyTo) payload.replyId = replyTo;
    
    // Батчинг операций для Firebase
    if (window.db) {
      const updates = {};
      const messageKey = window.db.ref(`rooms/${room}/messages`).push().key;
      updates[`rooms/${room}/messages/${messageKey}`] = payload;
      updates[`rooms/${room}/typing`] = null;
      
      // Одновременное обновление
      window.db.ref().update(updates);
    }
    
    // Очистка UI
    messageInput.value = "";
    replyTo = null;
    lastSent = now;
  }

  // Voice message functionality
  function startVoiceMessage() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert('Voice messages are not supported in this browser');
      return;
    }
    
    const micBtn = document.querySelector('.mic-btn');
    micBtn.style.background = '#ff4757';
    micBtn.style.color = '#fff';
    
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        // Here you would implement actual voice recording
        // For now, just show a visual indicator
        setTimeout(() => {
          micBtn.style.background = '#23243a';
          micBtn.style.color = '#6a5cff';
          alert('Voice message recorded! (Demo only)');
        }, 2000);
      })
      .catch(err => {
        micBtn.style.background = '#23243a';
        micBtn.style.color = '#6a5cff';
        alert('Could not access microphone');
      });
  }

  // Оптимизированные обработчики событий
  const roomSelector = document.getElementById("roomSelector");
  const nameInput = document.getElementById('nameInput');
  const messageInput = document.getElementById('messageInput');
  
  if (roomSelector) {
  roomSelector.onchange = () => { 
    // Очищаем индикатор печати при смене комнаты
    clearTimeout(typingTimer);
    if (window.db && isCurrentlyTyping) {
      window.db.ref(`rooms/${room}/typing`).set("");
      isCurrentlyTyping = false;
    }
    room = roomSelector.value; 
    loadRoom(); 
  };
  }
  if (nameInput) {
  nameInput.onchange = () => { localStorage.chatName = nameInput.value.trim(); };
  if(localStorage.chatName) nameInput.value = localStorage.chatName;
  }

  // Оптимизированный ввод с индикатором печати
  let typingDebounce;
  let isCurrentlyTyping = false;
  
  if (messageInput && nameInput) {
  messageInput.oninput = () => {
    const n = nameInput.value.trim();
      const msg = messageInput.value.trim();
      
      if (!n) return;
      
      // Очищаем предыдущие таймеры
      clearTimeout(typingDebounce);
      clearTimeout(typingTimer);
      
      if (msg.length > 0) {
        // Пользователь печатает - показываем индикатор сразу, если его еще нет
        if (!isCurrentlyTyping) {
    const t = translations[currentLanguage] || translations.en;
    const typingText = t.isTyping || 'is typing...';
        if (window.db) {
          window.db.ref(`rooms/${room}/typing`).set(`${n} ${typingText}`);
            isCurrentlyTyping = true;
          }
        }
        
        // Устанавливаем таймер для скрытия индикатора через 1.5 секунды бездействия
        typingTimer = setTimeout(() => {
          if (window.db) {
            window.db.ref(`rooms/${room}/typing`).set("");
            isCurrentlyTyping = false;
          }
        }, 1500);
        
      } else {
        // Поле ввода пустое - сразу скрываем индикатор
        if (window.db && isCurrentlyTyping) {
          window.db.ref(`rooms/${room}/typing`).set("");
          isCurrentlyTyping = false;
        }
      }
    };
    
    // При нажатии Enter или отправке сообщения - сразу скрываем индикатор
    messageInput.onkeydown = e => { 
      if(e.key === "Enter") {
    clearTimeout(typingTimer);
        if (window.db && isCurrentlyTyping) {
          window.db.ref(`rooms/${room}/typing`).set("");
          isCurrentlyTyping = false;
        }
        doSend(); 
      }
    };
    
    // При потере фокуса также скрываем индикатор
    messageInput.onblur = () => {
      clearTimeout(typingTimer);
      if (window.db && isCurrentlyTyping) {
        window.db.ref(`rooms/${room}/typing`).set("");
        isCurrentlyTyping = false;
      }
    };
  }
  
  const sendBtn = document.getElementById("sendBtn");
  if (sendBtn) {
    sendBtn.onclick = () => {
      // Очищаем индикатор печати при клике на кнопку отправки
      clearTimeout(typingTimer);
      if (window.db && isCurrentlyTyping) {
        window.db.ref(`rooms/${room}/typing`).set("");
        isCurrentlyTyping = false;
      }
      doSend();
    };
  }

  // Navigation tab listeners
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', (e) => {
      console.log('Tab clicked:', e.target.textContent);
      // Get the view name based on data-translate attribute
      const translateKey = e.target.dataset.translate;
      let view = 'chats'; // default
      
      if (translateKey === 'settings') {
        view = 'settings';
      } else if (translateKey === 'chats') {
        view = 'chats';
      }
      
      console.log('Switching to view:', view);
      switchView(view, e);
    });
  });

  // Microphone button
  document.querySelector('.mic-btn').addEventListener('click', startVoiceMessage);

  

  document.getElementById("imageBtn").onclick = () => imageInput.click();
  document.getElementById("imageInput").onchange = () => {
    const file = imageInput.files[0];
    if(!file) return;
    
    // Проверка размера файла (макс 5MB)
    if(file.size > 5 * 1024 * 1024) {
      showToast('Файл слишком большой. Максимум 5MB.', 'error');
      return;
    }
    
    // Сжатие изображения для оптимизации
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = () => {
      const maxWidth = 400;
      const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
      canvas.width = img.width * ratio;
      canvas.height = img.height * ratio;
      
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      const compressedData = canvas.toDataURL('image/jpeg', 0.8);
      
      const payload = {
        name: nameInput.value.trim(), 
        msg: window.enc(`<img src="${compressedData}" style="max-width:120px;" loading="lazy">`), 
        time: Date.now()
      };
      if (window.db) {
        window.db.ref(`rooms/${room}/messages`).push(payload);
      }
    };
    
    const reader = new FileReader();
    reader.onload = () => img.src = reader.result;
    reader.readAsDataURL(file);
  };

  document.getElementById("fileBtn").onclick = () => fileInput.click();
  document.getElementById("fileInput").onchange = () => {
    const file = fileInput.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      const a = `<a href="${reader.result}" download="${file.name}">${file.name}</a>`;
      if (window.db && window.enc) {
        window.db.ref(`rooms/${room}/messages`).push({
          name: nameInput.value.trim(), 
          msg: window.enc(a), 
          time: Date.now()
        });
      }
    };
    reader.readAsDataURL(file);
  };
  // Quick Translate functionality
  document.getElementById("quickTranslateBtn").onclick = showQuickTranslate;

  function showQuickTranslate() {
    const modal = document.getElementById('quickTranslateModal');
    const messageInput = document.getElementById('messageInput');
    const originalTextArea = document.getElementById('originalTextArea');
    const targetLanguageSelect = document.getElementById('targetLanguageSelect');
    
    // Set default target language to current UI language
    targetLanguageSelect.value = currentLanguage;
    
    // Pre-fill with current message input if any
    if (messageInput.value.trim()) {
      originalTextArea.value = messageInput.value.trim();
      translateText();
    }
    
    modal.classList.add('show');
    originalTextArea.focus();
  }

  function hideQuickTranslate() {
    const modal = document.getElementById('quickTranslateModal');
    modal.classList.remove('show');
    
    // Clear textareas and reset language detection
    document.getElementById('originalTextArea').value = '';
    document.getElementById('translatedTextArea').value = '';
    document.getElementById('detectedLanguage').style.display = 'none';
  }

  function useTranslatedText() {
    const translatedText = document.getElementById('translatedTextArea').value.trim();
    const messageInput = document.getElementById('messageInput');
    
    if (translatedText) {
      messageInput.value = translatedText;
      messageInput.focus();
    }
    
    hideQuickTranslate();
  }

  // Language selection functions
  function onLanguageChange() {
    const originalText = document.getElementById('originalTextArea').value.trim();
    if (originalText) {
      translateText();
    }
  }

  function swapLanguages() {
    const sourceSelect = document.getElementById('sourceLanguageSelect');
    const targetSelect = document.getElementById('targetLanguageSelect');
    const originalTextArea = document.getElementById('originalTextArea');
    const translatedTextArea = document.getElementById('translatedTextArea');
    
    // Don't swap if source is auto-detect
    if (sourceSelect.value === 'auto') return;
    
    // Swap language selections
    const tempLang = sourceSelect.value;
    sourceSelect.value = targetSelect.value;
    targetSelect.value = tempLang;
    
    // Swap text content
    const tempText = originalTextArea.value;
    originalTextArea.value = translatedTextArea.value;
    translatedTextArea.value = tempText;
    
    // Trigger translation if there's text
    if (originalTextArea.value.trim()) {
      translateText();
    }
  }

  // Language name mapping
  const languageNames = {
    ru: { ru: 'Русский', en: 'Russian', am: 'Ռուսերեն', fr: 'Russe', de: 'Russisch', es: 'Ruso' },
    en: { ru: 'Английский', en: 'English', am: 'Անգլերեն', fr: 'Anglais', de: 'Englisch', es: 'Inglés' },
    am: { ru: 'Армянский', en: 'Armenian', am: 'Հայերեն', fr: 'Arménien', de: 'Armenisch', es: 'Armenio' },
    fr: { ru: 'Французский', en: 'French', am: 'Ֆրանսերեն', fr: 'Français', de: 'Französisch', es: 'Francés' },
    de: { ru: 'Немецкий', en: 'German', am: 'Գերմաներեն', fr: 'Allemand', de: 'Deutsch', es: 'Alemán' },
    es: { ru: 'Испанский', en: 'Spanish', am: 'Իսպաներեն', fr: 'Espagnol', de: 'Spanisch', es: 'Español' },
    it: { ru: 'Итальянский', en: 'Italian', am: 'Իտալերեն', fr: 'Italien', de: 'Italienisch', es: 'Italiano' },
    pt: { ru: 'Португальский', en: 'Portuguese', am: 'Պորտուգալերեն', fr: 'Portugais', de: 'Portugiesisch', es: 'Portugués' },
    zh: { ru: 'Китайский', en: 'Chinese', am: 'Չինարեն', fr: 'Chinois', de: 'Chinesisch', es: 'Chino' },
    ja: { ru: 'Японский', en: 'Japanese', am: 'Ճապոներեն', fr: 'Japonais', de: 'Japanisch', es: 'Japonés' },
    ko: { ru: 'Корейский', en: 'Korean', am: 'Կորեերեն', fr: 'Coréen', de: 'Koreanisch', es: 'Coreano' },
    ar: { ru: 'Арабский', en: 'Arabic', am: 'Արաբերեն', fr: 'Arabe', de: 'Arabisch', es: 'Árabe' }
  };

  // Auto-translate when user types in original text area
  let translateTimeout;
  document.getElementById('originalTextArea').addEventListener('input', function() {
    clearTimeout(translateTimeout);
    translateTimeout = setTimeout(() => {
      if (this.value.trim()) {
        translateText();
      } else {
        document.getElementById('translatedTextArea').value = '';
        document.getElementById('detectedLanguage').style.display = 'none';
      }
    }, 500);
  });

  async function translateText() {
    const originalText = document.getElementById('originalTextArea').value.trim();
    const translatedTextArea = document.getElementById('translatedTextArea');
    const sourceLanguage = document.getElementById('sourceLanguageSelect').value;
    const targetLanguage = document.getElementById('targetLanguageSelect').value;
    const detectedLanguageDiv = document.getElementById('detectedLanguage');
    const detectedLanguageName = document.getElementById('detectedLanguageName');
    
    if (!originalText) return;
    
    const t = translations[currentLanguage] || translations.en;
    const loadingText = {
      ru: 'Переводится...',
      en: 'Translating...',
      am: 'Թարգմանվում է...',
      fr: 'Traduction...',
      de: 'Übersetzen...',
      es: 'Traduciendo...'
    };
    
    translatedTextArea.value = loadingText[currentLanguage] || loadingText.en;
    detectedLanguageDiv.style.display = 'none';
    
    try {
      let translatedText = null;
      let detectedLang = null;
      const sourceLang = sourceLanguage === 'auto' ? 'auto' : sourceLanguage;
      
      // Try MyMemory API first
      try {
        const langPair = sourceLang === 'auto' ? `autodetect|${targetLanguage}` : `${sourceLang}|${targetLanguage}`;
        const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(originalText)}&langpair=${langPair}`);
        const data = await response.json();
        if (data && data.responseData && data.responseData.translatedText) {
          translatedText = data.responseData.translatedText;
          // Try to extract detected language from MyMemory response
          if (sourceLang === 'auto' && data.responseData.match) {
            detectedLang = data.responseData.match.split('|')[0];
          }
        }
      } catch (e) {
        console.warn('MyMemory API failed:', e);
      }
      
      // Try LibreTranslate API as fallback
      if (!translatedText) {
        try {
          const response = await fetch('https://libretranslate.de/translate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              q: originalText,
              source: sourceLang === 'auto' ? 'auto' : sourceLang,
              target: targetLanguage,
              format: 'text'
            })
          });
          const data = await response.json();
          if (data && data.translatedText) {
            translatedText = data.translatedText;
          }
        } catch (e) {
          console.warn('LibreTranslate API failed:', e);
        }
      }
      
      // Try Google Translate as final fallback
      if (!translatedText) {
        try {
          const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLanguage}&dt=t&q=${encodeURIComponent(originalText)}`);
          const data = await response.json();
          if (data && data[0] && data[0][0] && data[0][0][0]) {
            translatedText = data[0][0][0];
            // Extract detected language from Google response
            if (sourceLang === 'auto' && data[2]) {
              detectedLang = data[2];
            }
          }
        } catch (e) {
          console.warn('Google Translate failed:', e);
        }
      }
      
      if (translatedText && translatedText !== originalText) {
        translatedTextArea.value = translatedText;
        
        // Show detected language if auto-detection was used
        if (sourceLang === 'auto' && detectedLang && languageNames[detectedLang]) {
          const langName = languageNames[detectedLang][currentLanguage] || languageNames[detectedLang].en || detectedLang;
          detectedLanguageName.textContent = langName;
          detectedLanguageDiv.style.display = 'block';
        }
      } else {
        const noTranslationText = {
          ru: 'Перевод недоступен',
          en: 'Translation unavailable',
          am: 'Թարգմանությունը հասանելի չէ',
          fr: 'Traduction indisponible',
          de: 'Übersetzung nicht verfügbar',
          es: 'Traducción no disponible'
        };
        translatedTextArea.value = noTranslationText[currentLanguage] || noTranslationText.en;
      }
      
    } catch (error) {
      console.warn('Translation failed:', error);
      const errorText = {
        ru: 'Ошибка перевода',
        en: 'Translation error',
        am: 'Թարգմանության սխալ',
        fr: 'Erreur de traduction',
        de: 'Übersetzungsfehler',
        es: 'Error de traducción'
      };
      translatedTextArea.value = errorText[currentLanguage] || errorText.en;
    }
  }

  // Close modal when clicking outside
  document.getElementById('quickTranslateModal').addEventListener('click', function(e) {
    if (e.target === this) {
      hideQuickTranslate();
    }
  });

  if("Notification" in window && Notification.permission !== "granted") Notification.requestPermission();



  if (window.db) {
    window.db.ref(`rooms/${room}/messages`).on("child_added", snap => {
    const m = snap.val();
      if(m.name !== nameInput.value.trim() && Notification.permission === "granted" && window.dec)
        new Notification(`Сообщение от ${m.name}`, { body: window.dec(m.msg).substring(0, 50) });
  });
  }

  // Authentication initialization
  document.getElementById('authModalBackdrop').addEventListener('click', (e) => {
    if (e.target === e.currentTarget && isAuthenticated) hideAuthModal();
  });

  // Terms of Service initialization
  document.getElementById('termsModalClose').addEventListener('click', hideTermsOfService);
  document.getElementById('termsModalBackdrop').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) hideTermsOfService();
  });

  // Check if user is already authenticated
  if (!checkExistingAuth()) {
    // Show auth modal if not authenticated - user must register or login
    setTimeout(() => showAuthModal(), 500);
  }

  loadRoom();
  // setStatus removed

  // Theme menu logic
  const navMenuBtn = document.getElementById('navMenuBtn');
  const themeMenu = document.getElementById('themeMenu');
  const themeMenuBackdrop = document.getElementById('themeMenuBackdrop');
  const themeMenuClose = document.getElementById('themeMenuClose');
  const themeLight = document.getElementById('themeLight');
  const themeDark = document.getElementById('themeDark');
  const themeAuto = document.getElementById('themeAuto');

  function openThemeMenu() {
    themeMenu.classList.add('open');
    themeMenuBackdrop.style.display = 'block';
    setTimeout(()=>themeMenuBackdrop.style.background = 'rgba(0,0,0,0.18)', 10);
  }
  function closeThemeMenu() {
    themeMenu.classList.remove('open');
    themeMenuBackdrop.style.background = 'rgba(0,0,0,0.12)';
    setTimeout(()=>themeMenuBackdrop.style.display = 'none', 250);
  }
  navMenuBtn.onclick = openThemeMenu;
  themeMenuBackdrop.onclick = closeThemeMenu;
  themeMenuClose.onclick = closeThemeMenu;

  // Theme switching logic
  function setTheme(theme) {
    document.body.classList.remove('theme-dark');
    if(theme === 'dark') document.body.classList.add('theme-dark');
    localStorage.theme = theme;
  }
  function applyTheme() {
    let theme = localStorage.theme || 'auto';
    if(theme === 'auto') {
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      setTheme(isDark ? 'dark' : 'light');
    } else {
      setTheme(theme);
    }
    if(theme === 'dark') themeDark.checked = true;
    else if(theme === 'light') themeLight.checked = true;
    else themeAuto.checked = true;
  }
  themeLight.onchange = ()=>setTheme('light');
  themeDark.onchange = ()=>setTheme('dark');
  themeAuto.onchange = ()=>setTheme('auto');
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);
  applyTheme();
  
  // Ensure UI language is applied after everything is loaded
  updateUILanguage(currentLanguage);
  
  // Service Worker для кэширования (PWA оптимизация)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      const swScript = `
        const CACHE_NAME = 'duotalk-v1';
        const urlsToCache = [
          '/',
          'https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap',
          'https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js',
          'https://www.gstatic.com/firebasejs/10.0.0/firebase-database-compat.js',
          'https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js',
          'https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js'
        ];
        
        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE_NAME)
              .then(cache => cache.addAll(urlsToCache))
          );
        });
        
        self.addEventListener('fetch', event => {
          event.respondWith(
            caches.match(event.request)
              .then(response => response || fetch(event.request))
          );
        });
      `;
      
      const blob = new Blob([swScript], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(blob);
      
      navigator.serviceWorker.register(swUrl)
        .then(registration => console.log('SW registered:', registration))
        .catch(error => console.log('SW registration failed:', error));
    });
  }
</script>
</body>
</html>
